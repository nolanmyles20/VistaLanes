<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bowling Betting Brackets</title>
  <style>
    :root{
      --bg:#000; /* web page = black */
      --border:rgba(255,255,255,.08);
      --text:#d8e1ee;
      --muted:#8ea0b5;
      --accent:#6aa7ff;
      --accent2:#7cf3c3;
      --danger:#ff5a6a;
      --success:#31d07f;
      --warn:#ffc84a;
      --silver:#b8c6d9;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;

      --matchH: 128px;
      --matchGap: 14px;
      --conn: rgba(255,255,255,.12);

      --treePadX: 14px;
      --treeGap: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 14px 60px}

    /* LOGO (WEB) */
    .brandbar{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:10px 0 6px;
    }
    .brandbar img{
      width:min(260px, 70vw);
      height:auto;
      display:block;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.55));
      opacity:.98;
    }

    /* ===== NAV BAR ===== */
    .navbar{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 0 18px;
    }
    .navbar a{ text-decoration:none; }
    .navbtn{
      padding:10px 18px;
      border-radius:999px;
      background:#d9d9d9;
      color:#000;
      font-weight:800;
      font-size:14px;
      border:1px solid rgba(0,0,0,.18);
      transition:.15s ease;
      display:inline-block;
      box-shadow: 0 8px 18px rgba(0,0,0,.28);
      user-select:none;
    }
    .navbtn:hover{
      background:#ffffff;
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(0,0,0,.38);
    }
    .navbtn:active{ transform:translateY(0); }

    /* Active = sunken */
    .navbtn.active{
      background:#bfbfbf;
      border-color: rgba(0,0,0,.24);
      box-shadow:
        inset 0 3px 8px rgba(0,0,0,.45),
        inset 0 -2px 6px rgba(255,255,255,.35);
      transform:none !important;
      cursor:default;
    }

    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px;}
    .title{display:flex;flex-direction:column;gap:6px;}
    .title h1{margin:0;font-size:22px;letter-spacing:.3px;font-weight:800;}
    .title .sub{color:var(--muted);font-size:13px;}
    .grid{display:grid;grid-template-columns: 1fr;gap:14px;}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      border-bottom:1px solid var(--border);
    }
    .panel .hd h2{margin:0;font-size:14px;letter-spacing:.4px;text-transform:uppercase;color:var(--muted);}
    .panel .bd{padding:14px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1 1 auto}

    input, select{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      outline:none;
      transition:.15s ease;
      max-width:100%;
    }
    input::placeholder{color:rgba(216,225,238,.35)}
    input:focus, select:focus{border-color: rgba(106,167,255,.5);box-shadow: 0 0 0 3px rgba(106,167,255,.15);}
    input[type="number"]{width:120px}
    .w-sm{width:160px}
    .w-md{width:240px}
    .w-xs{width:110px}

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 13px;
      border-radius: 999px;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex;gap:8px;align-items:center;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{background: linear-gradient(180deg, rgba(106,167,255,.22), rgba(106,167,255,.10));border-color: rgba(106,167,255,.40);}
    .btn.good{background: linear-gradient(180deg, rgba(124,243,195,.18), rgba(124,243,195,.08));border-color: rgba(124,243,195,.40);}
    .btn.danger{background: linear-gradient(180deg, rgba(255,90,106,.18), rgba(255,90,106,.08));border-color: rgba(255,90,106,.40);}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .chip{
      font-size:12px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      background: rgba(255,255,255,.03);
      display:inline-flex;gap:8px;align-items:center;
    }
    .chip b{color:var(--text)}
    .chip .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.25)}
    .chip.on .dot{background: var(--accent2)}

    .hint{font-size:12px;color:var(--muted);line-height:1.45}
    .warnText{font-size:12px;color:rgba(255,200,74,.9);line-height:1.45}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}

    .kpi{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .kpi .box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      padding:10px 12px;border-radius:16px;
      display:flex;gap:8px;align-items:baseline;
    }
    .kpi .box .lbl{font-size:12px;color:var(--muted)}
    .kpi .box .val{font-weight:900;font-size:16px}

    .two-col{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px;}
    @media (max-width: 980px){ .two-col{grid-template-columns:1fr} }

    .score-sections{display:grid;gap:12px}
    .score-section{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      border-radius: 18px;
      overflow:hidden;
    }
    .score-section .shd{
      padding:10px 12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .score-section .shd .ttl{font-weight:900;letter-spacing:.3px;}
    .score-section .shd .meta{font-size:12px;color:var(--muted);}
    .score-section .sbd{padding:12px}

    .score-list{display:grid;grid-template-columns: 1fr;gap:10px;}
    .score-item{
      display:grid;
      grid-template-columns: 1.1fr .7fr .7fr auto;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
    }
    @media (max-width: 780px){
      .score-item{grid-template-columns:1fr 1fr; grid-auto-rows:auto}
      .score-item .tag{grid-column:1/-1}
    }
    .tag{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      padding:6px 10px;
      justify-self:start;
    }

    .brackets{display:grid;grid-template-columns: 1fr 1fr;gap:14px;}
    @media (max-width: 980px){ .brackets{grid-template-columns:1fr} }

    .bracket{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      overflow:hidden;
    }
    .bracket .top{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .bracket .top .meta{display:flex;flex-direction:column;gap:4px;}
    .bracket .top .meta .name{font-weight:800;letter-spacing:.3px}
    .bracket .top .meta .small{font-size:12px;color:var(--muted)}
    .bracket .top .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .treeHead{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:var(--treeGap);
      padding: 0 var(--treePadX) 10px;
    }
    .treeHead h3{margin:0;font-size:12px;color:var(--muted);letter-spacing:.35px;text-transform:uppercase;}

    .treeScroll{overflow-x:hidden;overflow-y:hidden;-webkit-overflow-scrolling: touch;}
    .tree{
      position:relative;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:var(--treeGap);
      padding:12px var(--treePadX) 14px;
      overflow:hidden;
      border-radius: 18px;
      width:100%;
    }
    .col{display:flex;flex-direction:column;gap: var(--matchGap);min-width:0;}
    .col.r2{padding-top: calc((var(--matchH) + var(--matchGap)) / 2);}
    .r2Spacer{height: var(--matchH);}
    .col.final{justify-content:center;}

    .match{
      width:100%;
      height: var(--matchH);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      background: rgba(255,255,255,.02);
      padding:8px;
      position:relative;
      overflow:hidden;
      min-width:0;
    }

    .tree::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + (var(--matchH) + var(--matchGap)) + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + 2*(var(--matchH) + var(--matchGap)) + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + 3*(var(--matchH) + var(--matchGap)) + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(66.666% + 2px) calc(12px + (var(--matchH) + var(--matchGap))/2 + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(66.666% + 2px) calc(12px + (var(--matchH) + var(--matchGap))/2 + var(--matchH) + var(--matchH) + var(--matchGap) + var(--matchH) * 0.5) / 18px 1px no-repeat;
      opacity:.9;
    }

    .slot{
      display:flex;justify-content:space-between;align-items:center;
      padding:7px 10px;border-radius: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:8px;gap:8px;min-width:0;
    }
    .slot:last-child{margin-bottom:0}
    .slot .left{display:flex;flex-direction:column;gap:4px;min-width:0;}
    .slot .nm{
      font-weight:900;line-height:1.05;white-space:normal;overflow:hidden;text-overflow:ellipsis;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-word;
      font-size: clamp(12px, 2.6vw, 15px);
    }
    .slot .nm .nm1,.slot .nm .nm2{display:block;overflow:hidden;text-overflow:ellipsis;}
    .slot .sc{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.12;}
    .slot .right{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;white-space:nowrap;flex:0 0 auto;}
    .nm.winner{color:var(--success)}
    .nm.loser{color:var(--danger)}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.03);font-size:12px;color:var(--muted)}

    .badge{
      width:18px;height:18px;border-radius:6px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:900;line-height:1;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
    }
    .badge.gold{background: rgba(255,200,74,.14); border-color: rgba(255,200,74,.45); color: #ffd57a;}
    .badge.silver{background: rgba(184,198,217,.12); border-color: rgba(184,198,217,.42); color: #dbe6f6;}

    .foot{border-top:1px solid rgba(255,255,255,.08);padding:12px;display:grid;gap:10px;background: rgba(0,0,0,.10);}
    .winnerline{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      padding:10px 12px;border-radius: 16px;
    }
    .winnerline .who{display:flex;gap:10px;align-items:center;min-width:0}
    .winnerline .who .nm{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .winnerline .amt{font-weight:900}

    @media (max-width: 420px){
      :root{--treePadX: 10px;--treeGap: 10px;--matchGap: 12px;--matchH: 124px;}
      .treeHead h3{font-size:11px}
      .match{padding:7px;border-radius:14px}
      .slot{padding:7px 9px;border-radius:11px}
      .slot .sc{font-size:11px}
      .slot .nm{font-size: clamp(12px, 3.2vw, 14px);}
      .navbtn{padding:9px 14px;font-size:13px}
    }
    @media (orientation: landscape){
      :root{--treePadX: 18px;--treeGap: 14px;--matchH: 138px;}
      .treeScroll{overflow-x:auto}
      .tree{min-width: 920px;}
      .slot .nm{font-size: 15px;}
    }

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index: 9999;
    }
    .modal{
      width:min(720px, 100%); max-height:min(82vh, 720px);
      overflow:hidden; border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      display:flex; flex-direction:column;
    }
    .modal .mhd{
      padding:12px; border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .modal .mhd .ttl{font-weight:900;letter-spacing:.3px;}
    .modal .mhd .x{border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);color:var(--text);border-radius: 999px;padding:8px 11px;cursor:pointer;}
    .modal .mbd{padding:12px; overflow:auto;}
    .modal .mft{padding:12px; border-top:1px solid rgba(255,255,255,.10); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;}
    .list{display:grid; gap:10px;}
    .rowPick{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      cursor:pointer; transition:.12s ease;
    }
    .rowPick:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.14)}
    .rowPick .nm{font-weight:900}
    .rowPick .hc{color:var(--muted); font-size:12px}
    .pillSm{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.03);color:var(--muted);white-space:nowrap;}
    form{margin:0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGO TOP CENTERED (WEB) -->
    <div class="brandbar">
      <img src="assets/68D8CA4C-741E-41E1-ABBC-8B57D7FD0A57.png" alt="Logo" />
    </div>

    <!-- MENU BAR (grey rounded buttons, black text, active is sunken) -->
    <div class="navbar" id="navbar">
      <a href="home.html"><span class="navbtn" data-page="home.html index.html">Home</span></a>
      <a href="bowlers.html"><span class="navbtn" data-page="bowlers.html">Bowlers</span></a>
      <a href="leagues.html"><span class="navbtn" data-page="leagues.html">Leagues</span></a>
      <a href="teams.html"><span class="navbtn" data-page="teams.html">Teams</span></a>
      <a href="lanes.html"><span class="navbtn" data-page="lanes.html">Lanes</span></a>
      <a href="tournaments.html"><span class="navbtn" data-page="tournaments.html">Tournaments</span></a>
    </div>

    <header>
      <div class="title">
        <h1>Bowling Betting Brackets</h1>
        <div class="sub">Ties: Round1 uses Game2 as tiebreak • Round2 uses Game3 as tiebreak • Final tie splits pot evenly</div>
      </div>
      <div class="row">
        <span class="chip" id="chipOpen"><span class="dot"></span> <b id="openSpots">0</b> open spots</span>
        <button class="btn danger" id="btnReset" type="button">Reset</button>
      </div>
    </header>

    <div class="grid">
      <div class="panel">
        <div class="hd">
          <h2>Setup</h2>
          <div class="row">
            <button class="btn primary" id="btnAddBracket" type="button">+ Add Bracket</button>
          </div>
        </div>
        <div class="bd">
          <form id="setupForm">
            <div class="row">
              <input class="w-md" id="bowlerName" placeholder="Bowler name (tap to pick from list)" readonly />
              <button class="btn" id="btnPickBowler" type="button">Pick</button>

              <select id="entryType" class="w-sm">
                <option value="scratch">Enter Scratch bracket</option>
                <option value="handicap">Enter Handicap bracket</option>
              </select>

              <input type="number" id="bowlerHcp" placeholder="Handicap" />

              <input type="number" id="entryQty" class="w-xs" min="1" max="50" value="1" />
              <span class="pillSm">Qty</span>

              <button class="btn good" id="btnAddBowler" type="submit">Add Bowler</button>

              <div class="spacer"></div>
              <span class="hint">Tip: On iPhone, tap <b>Done</b> to add.</span>
            </div>
          </form>

          <div class="hr"></div>
          <div class="kpi">
            <div class="box"><span class="lbl">Brackets</span> <span class="val" id="kpiBrackets">0</span></div>
            <div class="box"><span class="lbl">Bowlers</span> <span class="val" id="kpiBowlers">0</span></div>
            <div class="box"><span class="lbl">Completed Brackets</span> <span class="val" id="kpiDone">0</span></div>
          </div>
          <div class="hr"></div>
          <div class="warnText" id="entryWarn" style="display:none"></div>
        </div>
      </div>

      <div class="two-col">
        <div class="panel">
          <div class="hd">
            <h2>Score Entry</h2>
            <div class="row">
              <button class="btn primary" id="btnApplyScores" type="button">Apply Scores</button>
            </div>
          </div>
          <div class="bd">
            <div class="hint">
              Matchups resolve as soon as the needed scores exist.
              If Round 1 ties, it waits for <b>Game 2</b>. If Round 2 ties, it waits for <b>Game 3</b>.
              If the final ties on Game 3, the pot is split evenly.
            </div>
            <div class="hr"></div>
            <div class="score-sections" id="scoreSections"></div>
          </div>
        </div>

        <div class="panel">
          <div class="hd">
            <h2>Total Payouts</h2>
            <div class="row">
              <input class="w-sm" id="filterName" placeholder="Filter by name…" />
              <select id="sortMode" class="w-sm">
                <option value="high">Winnings: High → Low</option>
                <option value="low">Winnings: Low → High</option>
                <option value="az">Name: A → Z</option>
                <option value="za">Name: Z → A</option>
              </select>
            </div>
          </div>
          <div class="bd">
            <div class="winners" id="payoutList"></div>
            <div class="hr"></div>
            <div class="kpi">
              <div class="box"><span class="lbl">Total Paid</span> <span class="val" id="kpiTotalPaid">$0</span></div>
              <div class="box"><span class="lbl">Winners</span> <span class="val" id="kpiWinners">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="hd">
          <h2>Brackets</h2>
          <div class="row">
            <span class="hint">Portrait fits without scrolling. Rotate landscape to see a larger bracket view.</span>
          </div>
        </div>
        <div class="bd">
          <div class="brackets" id="brackets"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="pickerBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Pick bowler">
      <div class="mhd">
        <div>
          <div class="ttl">Select Bowler</div>
          <div class="hint">Loaded from <span class="mono">data/bowlers.csv</span>, sorted by last name.</div>
        </div>
        <button class="x" id="pickerClose" type="button">Close</button>
      </div>

      <div class="mbd">
        <div class="row" style="margin-bottom:10px">
          <input class="w-md" id="pickerSearch" placeholder="Search name…" />
          <button class="btn" id="pickerReload" type="button">Reload CSV</button>
          <div class="spacer"></div>
          <span class="pillSm" id="pickerCount">0 bowlers</span>
        </div>

        <div class="hr"></div>

        <div class="row" style="margin-bottom:10px">
          <input class="w-md" id="pickerManualName" placeholder="Add bowler not listed (type name here)" />
          <input type="number" id="pickerManualHcp" placeholder="Handicap" />
          <button class="btn good" id="pickerUseManual" type="button">Use New Bowler</button>
          <span class="hint" id="manualHint"></span>
        </div>

        <div class="list" id="pickerList"></div>
      </div>

      <div class="mft">
        <button class="btn" id="pickerClear" type="button">Clear Selection</button>
        <button class="btn primary" id="pickerUseSelected" type="button">Use Selected</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const LOGO_PATH = "assets/68D8CA4C-741E-41E1-ABBC-8B57D7FD0A57.png";

  const state = { bowlers: new Map(), brackets: [], roster: [], rosterLoaded:false, selectedRoster:null };
  const BRACKET_SIZE = 8;

  const $ = (id)=>document.getElementById(id);
  const money = (n)=>"$"+Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
  const normalizeName = (name)=>String(name||"").trim().replace(/\s+/g," ");
  const escapeHtml = (s)=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const escapeAttr = (s)=>escapeHtml(s).replace(/"/g,'&quot;');

  // Sunken active menu button based on current filename
  function setActiveNav(){
    const file = (location.pathname.split("/").pop() || "home.html").toLowerCase();
    document.querySelectorAll("#navbar .navbtn").forEach(btn=>{
      const pages = (btn.getAttribute("data-page") || "").toLowerCase().split(/\s+/).filter(Boolean);
      const active = pages.includes(file) || (file==="" && pages.includes("home.html"));
      btn.classList.toggle("active", active);
    });
  }

  function makeMatch(){ return {a:null,b:null,winner:null,loser:null,tie:false,tieNeedsRound:null,finalSplit:false,splitEach:0,splitWith:[]}; }
  function makeBracket(id, type="scratch"){
    return { id, type, payout1:0, payout2:0, slots:Array(BRACKET_SIZE).fill(null),
      r1:Array.from({length:4}, makeMatch), r2:Array.from({length:2}, makeMatch), r3:Array.from({length:1}, makeMatch),
      champion:null, runnerUp:null
    };
  }
  function rebuildMatchesFromSlots(br){
    const pairs=[[0,1],[2,3],[4,5],[6,7]];
    br.r1.forEach((m,i)=>{ const [p,q]=pairs[i]; Object.assign(m, makeMatch()); m.a=br.slots[p]||null; m.b=br.slots[q]||null; });
    br.r2.forEach(m=>Object.assign(m, makeMatch()));
    br.r3.forEach(m=>Object.assign(m, makeMatch()));
    br.champion=null; br.runnerUp=null;
  }

  function openSpotsCount(){
    let open=0; for(const b of state.brackets){ for(const s of b.slots) if(!s) open++; }
    return open;
  }
  function addBracket(type="scratch"){
    const id = state.brackets.length+1;
    const br = makeBracket(id,type);
    state.brackets.push(br);
    renderAll();
    return br;
  }

  function ensureBowler(name, hcp){
    const key = normalizeName(name);
    if(!key) return null;
    if(!state.bowlers.has(key)) state.bowlers.set(key,{name:key,hcp:Number(hcp||0),scores:{}});
    else{
      const b = state.bowlers.get(key);
      if(hcp!=="" && hcp!==null && hcp!==undefined && !Number.isNaN(Number(hcp))) b.hcp = Number(hcp);
    }
    return state.bowlers.get(key);
  }

  function bracketAlreadyHasBowler(br, name){ return br.slots.includes(name); }

  function ensureOneOpenBracketForType(type){
    if(!state.brackets.some(b=>b.type===type)) addBracket(type);
    const anyOpen = state.brackets.some(b=>b.type===type && b.slots.some(s=>!s));
    if(!anyOpen) addBracket(type);
  }

  function placeBowlerOncePerBracket(name, type){
    name = normalizeName(name);
    if(!name) return {ok:false,msg:"Name is blank"};

    ensureOneOpenBracketForType(type);

    const candidates = [];
    state.brackets.forEach(br=>{
      if(br.type!==type) return;
      if(bracketAlreadyHasBowler(br, name)) return;
      const openSlots = br.slots.map((s,i)=>({s,i})).filter(x=>!x.s);
      if(openSlots.length) candidates.push({br, openSlots});
    });

    if(!candidates.length){
      const br = addBracket(type);
      const si = br.slots.findIndex(s=>!s);
      br.slots[si]=name;
      rebuildMatchesFromSlots(br);
      return {ok:true,msg:""};
    }

    const pick = candidates[Math.floor(Math.random()*candidates.length)];
    const si = pick.openSlots[Math.floor(Math.random()*pick.openSlots.length)].i;
    pick.br.slots[si]=name;
    rebuildMatchesFromSlots(pick.br);
    return {ok:true,msg:""};
  }

  function scoreForMatch(br, bowlerName, game){
    if(!bowlerName) return null;
    const bowler = state.bowlers.get(bowlerName);
    if(!bowler) return null;
    const base = bowler.scores[game];
    if(base===undefined||base===null||base==="") return null;
    const val = Number(base);
    if(Number.isNaN(val)) return null;
    return br.type==="handicap" ? (val + Number(bowler.hcp||0)) : val;
  }

  function decideMatchWinner(br, match, baseGame){
    match.winner=null; match.loser=null; match.tie=false; match.tieNeedsRound=null;
    match.finalSplit=false; match.splitEach=0; match.splitWith=[];
    if(!match.a || !match.b) return;

    const sA=scoreForMatch(br,match.a,baseGame);
    const sB=scoreForMatch(br,match.b,baseGame);
    if(sA===null || sB===null) return;

    if(sA!==sB){
      match.winner = (sA>sB)?match.a:match.b;
      match.loser  = (sA>sB)?match.b:match.a;
      return;
    }

    match.tie=true;

    if(baseGame===3){
      const totalPot = Number(br.payout1||0)+Number(br.payout2||0);
      match.finalSplit=true;
      match.splitEach=totalPot/2;
      match.splitWith=[match.a,match.b];
      return;
    }

    const tbGame = baseGame+1;
    match.tieNeedsRound = tbGame;

    const tA=scoreForMatch(br,match.a,tbGame);
    const tB=scoreForMatch(br,match.b,tbGame);
    if(tA===null || tB===null) return;

    if(tA!==tB){
      match.winner = (tA>tB)?match.a:match.b;
      match.loser  = (tA>tB)?match.b:match.a;
      match.tie=false;
      match.tieNeedsRound=null;
      return;
    }

    const pickA = Math.random()<0.5;
    match.winner = pickA?match.a:match.b;
    match.loser  = pickA?match.b:match.a;
    match.tie=false;
    match.tieNeedsRound=null;
  }

  function advanceBracketIfReady(br){
    br.r1.forEach(m=>decideMatchWinner(br,m,1));
    br.r2.forEach((m,i)=>{
      const w1=br.r1[i*2]?.winner||null;
      const w2=br.r1[i*2+1]?.winner||null;
      m.a=w1; m.b=w2;
      decideMatchWinner(br,m,2);
    });
    br.r3[0].a = br.r2[0]?.winner||null;
    br.r3[0].b = br.r2[1]?.winner||null;
    decideMatchWinner(br, br.r3[0], 3);

    const fin = br.r3[0];
    if(fin.finalSplit){ br.champion=null; br.runnerUp=null; return; }
    if(fin.winner && fin.loser){ br.champion=fin.winner; br.runnerUp=fin.loser; }
    else { br.champion=null; br.runnerUp=null; }
  }

  function matchNeededGame(br, match, baseGame, name){
    if(!match.a || !match.b) return null;
    if(!(match.a===name || match.b===name)) return null;
    if(match.winner || match.loser || match.finalSplit) return null;

    const sA=scoreForMatch(br,match.a,baseGame);
    const sB=scoreForMatch(br,match.b,baseGame);
    if(sA===null || sB===null) return baseGame;

    if(sA===sB && baseGame<3){
      const tb=baseGame+1;
      const tA=scoreForMatch(br,match.a,tb);
      const tB=scoreForMatch(br,match.b,tb);
      if(tA===null || tB===null) return tb;
    }
    return null;
  }

  function neededGameForBowler(name){
    let needed=null;
    for(const br of state.brackets){
      if(!br.slots.includes(name)) continue;
      advanceBracketIfReady(br);

      const eliminated =
        br.r1.some(m=>m.loser===name) ||
        br.r2.some(m=>m.loser===name) ||
        br.r3.some(m=>m.loser===name);

      if(eliminated) continue;

      for(const m of br.r1){ const g=matchNeededGame(br,m,1,name); if(g) needed = needed===null?g:Math.min(needed,g); }
      for(const m of br.r2){ const g=matchNeededGame(br,m,2,name); if(g) needed = needed===null?g:Math.min(needed,g); }
      for(const m of br.r3){ const g=matchNeededGame(br,m,3,name); if(g) needed = needed===null?g:Math.min(needed,g); }
    }
    return needed;
  }

  function scoreUsesForName(name){
    const uses=[];
    for(const br of state.brackets){
      if(!br.slots.includes(name)) continue;
      uses.push(`#${br.id} ${br.type==="handicap"?"HCP":"SCR"}`);
    }
    return uses;
  }

  function winningsByBowler(){
    const totals=new Map();
    for(const br of state.brackets){
      advanceBracketIfReady(br);
      const p1=Number(br.payout1||0), p2=Number(br.payout2||0);

      if(br.champion) totals.set(br.champion,(totals.get(br.champion)||0)+p1);
      if(br.runnerUp) totals.set(br.runnerUp,(totals.get(br.runnerUp)||0)+p2);

      const fin=br.r3[0];
      if(fin.finalSplit && fin.splitWith.length===2){
        totals.set(fin.splitWith[0], (totals.get(fin.splitWith[0])||0) + fin.splitEach);
        totals.set(fin.splitWith[1], (totals.get(fin.splitWith[1])||0) + fin.splitEach);
      }
    }
    return totals;
  }

  function showEntryWarn(msg){
    const el=$("entryWarn");
    if(!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block"; el.textContent=msg;
  }

  function renderKPIs(){
    $("kpiBrackets").textContent=String(state.brackets.length);
    $("kpiBowlers").textContent=String(state.bowlers.size);

    let done=0;
    state.brackets.forEach(br=>{
      advanceBracketIfReady(br);
      const fin=br.r3[0];
      if((br.champion && br.runnerUp) || (fin && fin.finalSplit)) done++;
    });
    $("kpiDone").textContent=String(done);

    const open=openSpotsCount();
    $("openSpots").textContent=String(open);
    $("chipOpen").classList.toggle("on", open>0);
  }

  function renderTotals(){
    const totals=winningsByBowler();
    const filter=($("filterName").value||"").trim().toLowerCase();
    const mode=$("sortMode").value;

    let items=Array.from(totals.entries()).map(([name,amt])=>({name,amt}));
    if(filter) items=items.filter(x=>x.name.toLowerCase().includes(filter));

    items.sort((a,b)=>{
      if(mode==="high") return b.amt-a.amt;
      if(mode==="low") return a.amt-b.amt;
      if(mode==="az") return a.name.localeCompare(b.name);
      if(mode==="za") return b.name.localeCompare(a.name);
      return 0;
    });

    const root=$("payoutList");
    root.innerHTML="";
    if(!items.length){
      root.innerHTML=`<div class="hint">No payouts yet. Finish a bracket final and set payouts.</div>`;
    } else {
      for(const it of items){
        const row=document.createElement("div");
        row.className="winnerline";
        row.innerHTML=`
          <div class="who">
            <span class="pill">WIN</span>
            <div class="nm">${escapeHtml(it.name)}</div>
          </div>
          <div class="amt">${money(it.amt)}</div>`;
        root.appendChild(row);
      }
    }

    const totalPaid=items.reduce((s,x)=>s+x.amt,0);
    $("kpiTotalPaid").textContent=money(totalPaid);
    $("kpiWinners").textContent=String(items.length);
  }

  function renderScoreSections(){
    const root=$("scoreSections");
    root.innerHTML="";

    const byGame={1:[],2:[],3:[]};
    for(const [name] of state.bowlers.entries()){
      const g=neededGameForBowler(name);
      if(g===1||g===2||g===3) byGame[g].push(name);
    }
    byGame[1].sort((a,b)=>a.localeCompare(b));
    byGame[2].sort((a,b)=>a.localeCompare(b));
    byGame[3].sort((a,b)=>a.localeCompare(b));

    const titles={1:"Game 1 (Round 1)",2:"Game 2 (Round 2 / R1 Tiebreak)",3:"Game 3 (Final / R2 Tiebreak)"};

    [1,2,3].forEach(game=>{
      const names=byGame[game];
      const sec=document.createElement("div");
      sec.className="score-section";
      sec.innerHTML=`
        <div class="shd">
          <div class="ttl">${titles[game]}</div>
          <div class="meta">${names.length} bowler${names.length===1?"":"s"} need this score</div>
        </div>
        <div class="sbd">
          <div class="score-list" id="scoreList_${game}">
            ${names.length ? "" : `<div class="hint">No active bowlers needing Game ${game} right now.</div>`}
          </div>
        </div>`;
      root.appendChild(sec);

      const list=sec.querySelector(`#scoreList_${game}`);
      if(!names.length) return;

      names.forEach(name=>{
        const bowler=state.bowlers.get(name);
        const val=bowler?.scores?.[game] ?? "";
        const uses=scoreUsesForName(name);
        const item=document.createElement("div");
        item.className="score-item";
        item.innerHTML=`
          <div>
            <div style="font-weight:900">${escapeHtml(name)}</div>
            <div class="muted" style="font-size:12px">HCP: <span class="mono">${Number(bowler?.hcp||0)}</span></div>
          </div>
          <input type="number" class="scoreInput" data-game="${game}" data-name="${escapeAttr(name)}" placeholder="Score" value="${escapeAttr(val)}" />
          <div class="tag">${uses.length ? uses.join(" • ") : "—"}</div>
          <button class="btn" data-clear="${escapeAttr(name)}" data-clear-game="${game}" type="button">Clear</button>
        `;
        list.appendChild(item);
      });
    });

    root.querySelectorAll("[data-clear]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const name=btn.getAttribute("data-clear");
        const game=Number(btn.getAttribute("data-clear-game"));
        const b=state.bowlers.get(name);
        if(!b) return;
        delete b.scores[game];
        renderAll();
      });
    });
  }

  function formatNameTwoLines(name){
    if(!name) return "";
    const parts=String(name).trim().split(/\s+/).filter(Boolean);
    if(parts.length<=1) return escapeHtml(name);
    const first=parts[0];
    const rest=parts.slice(1).join(" ");
    return `<span class="nm1">${escapeHtml(first)}</span><span class="nm2">${escapeHtml(rest)}</span>`;
  }

  function renderSlotHTML(br, name, match, baseGame){
    const raw = name ? (state.bowlers.get(name)?.scores?.[baseGame] ?? "") : "";
    const adj = scoreForMatch(br, name, baseGame);
    const showAdj = (br.type==="handicap" && name && raw!=="")
      ? ` +HCP ${Number(state.bowlers.get(name)?.hcp||0)} = <b class="mono">${adj ?? "—"}</b>`
      : "";

    const winner=match.winner, loser=match.loser;
    let cls="";
    if(name && winner && name===winner) cls="winner";
    if(name && loser && name===loser) cls="loser";

    let tiePill="";
    if(match.finalSplit) tiePill=`<span class="pill">FINAL SPLIT</span>`;
    else if(match.tie && !match.winner) tiePill = match.tieNeedsRound ? `<span class="pill">TIE → G${match.tieNeedsRound}</span>` : `<span class="pill">TIE</span>`;

    return `
      <div class="slot">
        <div class="left">
          <div class="nm ${cls}">${name ? formatNameTwoLines(name) : `<span class="muted">— empty —</span>`}</div>
          <div class="sc">${name ? `G${baseGame}: <span class="mono">${raw===""?"—":raw}</span>${showAdj}` : `<span class="muted">Add bowlers to fill slots</span>`}</div>
        </div>
        <div class="right">
          ${tiePill}
          ${name && winner && name===winner ? `<span class="pill">WIN</span>` : ``}
          ${name && loser && name===loser ? `<span class="pill">OUT</span>` : ``}
        </div>
      </div>`;
  }

  function renderMatchCard(br, m, baseGame){
    return `<div class="match">${renderSlotHTML(br,m.a,m,baseGame)}${renderSlotHTML(br,m.b,m,baseGame)}</div>`;
  }

  function renderFinalResults(br){
    const p1=Number(br.payout1||0), p2=Number(br.payout2||0);
    const fin=br.r3[0];

    if(fin.finalSplit && fin.splitWith.length===2){
      const each=fin.splitEach;
      return `
        <div class="winnerline">
          <div class="who">
            <span class="badge gold">≡</span>
            <div style="min-width:0">
              <div class="nm" style="color:var(--warn)">Final tied — split pot</div>
              <div class="muted" style="font-size:12px">(${money(p1)} + ${money(p2)}) ÷ 2 = <b>${money(each)}</b> each</div>
            </div>
          </div>
          <div class="amt">${money(each)}</div>
        </div>`;
    }

    if(!br.champion || !br.runnerUp){
      return `<div class="hint">Final results will appear here after the final matchup has both scores (and payouts are set).</div>`;
    }

    return `
      <div class="winnerline">
        <div class="who">
          <span class="badge gold">1</span>
          <div style="min-width:0">
            <div class="nm" style="color:var(--success)">${escapeHtml(br.champion)}</div>
            <div class="muted" style="font-size:12px">1st place</div>
          </div>
        </div>
        <div class="amt">${money(p1)}</div>
      </div>

      <div class="winnerline">
        <div class="who">
          <span class="badge silver">2</span>
          <div style="min-width:0">
            <div class="nm" style="color:var(--silver)">${escapeHtml(br.runnerUp)}</div>
            <div class="muted" style="font-size:12px">2nd place</div>
          </div>
        </div>
        <div class="amt">${money(p2)}</div>
      </div>`;
    }

    function saveBracketToPDF(brId){
    const el = document.getElementById(`bracket_${brId}`);
    if(!el) return;

    const clone = el.cloneNode(true);

    // Remove Save/Delete button
    clone.querySelectorAll("[data-save-del]").forEach(b => b.remove());

    const html = `
    <!doctype html>
    <html>
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <title>Bracket #${brId}</title>

      <style>
        *{box-sizing:border-box}

        body{
          margin:0;
          padding:24px;
          background:#ffffff !important;
          color:#000 !important;
          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        /* Logo */
        .exportHeader{
          display:flex;
          justify-content:center;
          align-items:center;
          margin-bottom:20px;
        }

        .exportLogo{
          width:260px;
          max-width:80%;
          height:auto;
        }

        /* Preserve bracket layout */
        .bracket{
          border:1px solid #d0d0d0 !important;
          background:#ffffff !important;
          border-radius:18px;
          overflow:hidden;
        }

        .top{
          background:#ffffff !important;
          border-bottom:1px solid #d0d0d0 !important;
        }

        .tree{
          background:#ffffff !important;
        }

        .match{
          background:#ffffff !important;
          border:1px solid #d0d0d0 !important;
        }

        .slot{
          background:#ffffff !important;
          border:1px solid #e0e0e0 !important;
        }

        .tree::before{
          opacity:.6 !important;
        }

        /* Text colors for print */
        .nm.winner{ color:#0a8a3a !important; }
        .nm.loser{ color:#c20000 !important; }

        .pill, .badge{
          background:#f4f4f4 !important;
          border:1px solid #cccccc !important;
          color:#000 !important;
        }

        .winnerline{
          background:#ffffff !important;
          border:1px solid #d0d0d0 !important;
        }

        .muted, .small, .sc, .hint, .tag{
          color:#333 !important;
        }

        @media print{
          body{padding:0}
        }
      </style>
    </head>
    <body>

      <div class="exportHeader">
        <img class="exportLogo" src="${LOGO_PATH}" />
      </div>

      ${clone.outerHTML}

      <script>
        setTimeout(function(){ window.print(); }, 300);
      <\/script>

    </body>
    </html>
    `;

    const w = window.open("", "_blank");
    if(!w) return;
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function deleteBracketById(brId){
    state.brackets = state.brackets.filter(b=>b.id!==brId);
    state.brackets.forEach((b,i)=>b.id=i+1);
    renderAll();
  }

  function renderBrackets(){
    const root=$("brackets");
    root.innerHTML="";

    for(const br of state.brackets){
      advanceBracketIfReady(br);

      const card=document.createElement("div");
      card.className="bracket";
      card.id=`bracket_${br.id}`;
      card.innerHTML=`
        <div class="top">
          <div class="meta">
            <div class="name">Bracket #${br.id}</div>
            <div class="small">
              Type: <b>${br.type==="handicap"?"Handicap":"Scratch"}</b> •
              Slots: <b>${br.slots.filter(Boolean).length}/8</b>
            </div>
          </div>
          <div class="tools">
            <select data-type="${br.id}">
              <option value="scratch" ${br.type==="scratch"?"selected":""}>Scratch</option>
              <option value="handicap" ${br.type==="handicap"?"selected":""}>Handicap</option>
            </select>
            <input type="number" class="w-sm" data-p1="${br.id}" placeholder="1st payout" value="${escapeAttr(br.payout1||"")}" />
            <input type="number" class="w-sm" data-p2="${br.id}" placeholder="2nd payout" value="${escapeAttr(br.payout2||"")}" />
            <button class="btn danger" data-save-del="${br.id}" type="button">Save + Delete</button>
          </div>
        </div>

        <div class="treeHead">
          <h3>Round 1</h3>
          <h3>Round 2</h3>
          <h3>Final</h3>
        </div>

        <div class="treeScroll">
          <div class="tree">
            <div class="col r1">
              ${renderMatchCard(br, br.r1[0], 1)}
              ${renderMatchCard(br, br.r1[1], 1)}
              ${renderMatchCard(br, br.r1[2], 1)}
              ${renderMatchCard(br, br.r1[3], 1)}
            </div>

            <div class="col r2">
              ${renderMatchCard(br, br.r2[0], 2)}
              <div class="r2Spacer"></div>
              ${renderMatchCard(br, br.r2[1], 2)}
            </div>

            <div class="col final">
              ${renderMatchCard(br, br.r3[0], 3)}
            </div>
          </div>
        </div>

        <div class="foot">
          ${renderFinalResults(br)}
        </div>
      `;
      root.appendChild(card);
    }

    root.querySelectorAll("[data-type]").forEach(sel=>{
      sel.addEventListener("change", ()=>{
        const id=Number(sel.getAttribute("data-type"));
        const br=state.brackets.find(b=>b.id===id);
        if(!br) return;
        br.type=sel.value;
        renderAll();
      });
    });

    root.querySelectorAll("[data-p1]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id=Number(inp.getAttribute("data-p1"));
        const br=state.brackets.find(b=>b.id===id);
        if(!br) return;
        br.payout1=Number(inp.value||0);
        renderTotals(); renderKPIs();
      });
    });
    root.querySelectorAll("[data-p2]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id=Number(inp.getAttribute("data-p2"));
        const br=state.brackets.find(b=>b.id===id);
        if(!br) return;
        br.payout2=Number(inp.value||0);
        renderTotals(); renderKPIs();
      });
    });

    root.querySelectorAll("[data-save-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=Number(btn.getAttribute("data-save-del"));
        saveBracketToPDF(id);
        deleteBracketById(id);
      });
    });
  }

  function applyScoresFromInputs(){
    document.querySelectorAll(".scoreInput").forEach(inp=>{
      const name=inp.getAttribute("data-name");
      const game=Number(inp.getAttribute("data-game"));
      const b=state.bowlers.get(name);
      if(!b) return;

      const v=inp.value;
      if(v===""||v===null||v===undefined) return;
      const n=Number(v);
      if(!Number.isNaN(n)) b.scores[game]=n;
    });
    state.brackets.forEach(br=>advanceBracketIfReady(br));
  }

  // ---- CSV roster / picker ----
  function splitCSVLine(line){
    const res=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c === '"' ){
        if(q && line[i+1]==='"'){ cur+='"'; i++; }
        else q=!q;
      } else if(c === ',' && !q){
        res.push(cur); cur="";
      } else cur+=c;
    }
    res.push(cur);
    return res;
  }
  function parseCSV(text){
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim()!=="");
    if(!lines.length) return [];
    const header = splitCSVLine(lines[0]).map(h=>h.trim());
    const out=[];
    for(let i=1;i<lines.length;i++){
      const cols = splitCSVLine(lines[i]);
      const obj = {};
      header.forEach((h,idx)=> obj[h]= (cols[idx]??"").trim());
      out.push(obj);
    }
    return out;
  }
  function lastNameKey(name){
    const parts = normalizeName(name).split(" ").filter(Boolean);
    if(parts.length<=1) return parts[0] || "";
    return parts[parts.length-1] + ", " + parts.slice(0,-1).join(" ");
  }
  function sortByLastName(a,b){
    const la = lastNameKey(a);
    const lb = lastNameKey(b);
    if(la !== lb) return la.localeCompare(lb);
    return a.localeCompare(b);
  }
  function normalizeRosterRow(r){
    const keys = Object.keys(r).map(k=>k.toLowerCase());
    const get = (name) => {
      const idx = keys.indexOf(name);
      if(idx<0) return "";
      return r[Object.keys(r)[idx]];
    };

    let name = "";
    const first = get("first") || get("firstname") || get("first_name");
    const last  = get("last")  || get("lastname")  || get("last_name");
    if(first || last) name = normalizeName([first,last].filter(Boolean).join(" "));
    else name = normalizeName(get("name") || get("bowler") || get("bowlername") || get("player"));

    let h = get("handicap") || get("hcp") || get("hdcp");
    h = h==="" ? "" : String(h);
    const handicap = h==="" ? null : (Number.isNaN(Number(h)) ? null : Number(h));
    return {name, handicap};
  }
  async function loadRoster(){
    try{
      const res = await fetch("data/bowlers.csv", {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text = await res.text();
      const rows = parseCSV(text);
      const roster = rows.map(r => normalizeRosterRow(r)).filter(r => r && r.name).sort((a,b)=> sortByLastName(a.name,b.name));
      state.roster = roster;
      state.rosterLoaded = true;
      renderPickerList();
    }catch(e){
      state.roster = [];
      state.rosterLoaded = false;
      renderPickerList();
    }
  }

  function openPicker(){
    $("pickerBackdrop").style.display="flex";
    $("pickerBackdrop").setAttribute("aria-hidden","false");
    $("pickerSearch").value = "";
    $("pickerManualName").value = "";
    $("pickerManualHcp").value = "";
    state.selectedRoster = null;
    renderPickerList();
    updateManualHint();
  }
  function closePicker(){
    $("pickerBackdrop").style.display="none";
    $("pickerBackdrop").setAttribute("aria-hidden","true");
  }
  function renderPickerList(){
    const list = $("pickerList");
    const q = ($("pickerSearch").value||"").trim().toLowerCase();
    list.innerHTML = "";

    const roster = (state.roster||[]).filter(r=>{
      if(!q) return true;
      return r.name.toLowerCase().includes(q);
    });

    $("pickerCount").textContent = `${roster.length} bowlers`;

    if(!state.rosterLoaded){
      const div = document.createElement("div");
      div.className = "hint";
      div.innerHTML = `Could not load <span class="mono">data/bowlers.csv</span>. You can still type a new bowler above.`;
      list.appendChild(div);
      return;
    }
    if(!roster.length){
      const div = document.createElement("div");
      div.className = "hint";
      div.textContent = "No matches. You can add a new bowler above.";
      list.appendChild(div);
      return;
    }

    roster.forEach(r=>{
      const row = document.createElement("div");
      row.className = "rowPick";
      row.innerHTML = `
        <div style="min-width:0">
          <div class="nm">${escapeHtml(r.name)}</div>
          <div class="hc">${r.handicap==null ? "HCP: —" : `HCP: <span class="mono">${r.handicap}</span>`}</div>
        </div>
        <div class="pillSm">${escapeHtml(lastNameKey(r.name))}</div>
      `;
      row.addEventListener("click", ()=>{
        state.selectedRoster = r;
        document.querySelectorAll(".rowPick").forEach(x=>x.style.outline="none");
        row.style.outline = "2px solid rgba(106,167,255,.45)";
        row.style.outlineOffset = "2px";
      });
      list.appendChild(row);
    });
  }

  function applyPickedBowler(name, handicap){
    $("bowlerName").value = normalizeName(name);
    if(handicap!==null && handicap!==undefined && handicap!=="" && !Number.isNaN(Number(handicap))){
      $("bowlerHcp").value = String(Number(handicap));
    }
    updateHcpVisibility();
  }
  function updateHcpVisibility(){
    const type = $("entryType").value;
    $("bowlerHcp").style.display = (type==="handicap") ? "" : "none";
    $("bowlerHcp").disabled = (type!=="handicap");
    $("pickerManualHcp").style.display = (type==="handicap") ? "" : "none";
    $("pickerManualHcp").disabled = (type!=="handicap");
  }
  function updateManualHint(){
    const type = $("entryType").value;
    $("manualHint").textContent = (type==="handicap")
      ? "If the bowler isn't listed, enter a name + handicap here."
      : "Scratch entry: handicap is hidden/ignored.";
  }

  // ---- events ----
  $("btnAddBracket").addEventListener("click", ()=>addBracket("scratch"));

  $("btnReset").addEventListener("click", ()=>{
    state.bowlers.clear();
    state.brackets = [];
    $("entryQty").value = "1";
    showEntryWarn("");
    renderAll();
  });

  $("filterName").addEventListener("input", renderTotals);
  $("sortMode").addEventListener("change", renderTotals);

  $("btnApplyScores").addEventListener("click", ()=>{ applyScoresFromInputs(); renderAll(); });

  $("setupForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    showEntryWarn("");

    const name = normalizeName($("bowlerName").value || "");
    const type = $("entryType").value;
    const qty  = Math.max(1, Math.min(50, Number($("entryQty").value || 1)));

    if(!name){
      showEntryWarn("Pick a bowler first.");
      return;
    }

    const hcp = (type==="handicap") ? $("bowlerHcp").value : "";
    ensureBowler(name, hcp);

    for(let i=0;i<qty;i++){
      const res = placeBowlerOncePerBracket(name, type);
      if(!res.ok){
        showEntryWarn(res.msg || "Could not place bowler.");
        break;
      }
    }

    $("entryQty").value="1";
    renderAll();
  });

  $("entryType").addEventListener("change", ()=>{
    updateHcpVisibility();
    updateManualHint();
    if($("entryType").value==="scratch") $("bowlerHcp").value="";
  });

  $("bowlerName").addEventListener("click", openPicker);
  $("btnPickBowler").addEventListener("click", openPicker);
  $("pickerClose").addEventListener("click", closePicker);
  $("pickerBackdrop").addEventListener("click", (e)=>{ if(e.target === $("pickerBackdrop")) closePicker(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && $("pickerBackdrop").style.display==="flex") closePicker(); });

  $("pickerSearch").addEventListener("input", renderPickerList);
  $("pickerReload").addEventListener("click", async ()=>{ await loadRoster(); });

  $("pickerUseSelected").addEventListener("click", ()=>{
    if(!state.selectedRoster){ closePicker(); return; }
    applyPickedBowler(state.selectedRoster.name, state.selectedRoster.handicap);
    closePicker();
    setTimeout(()=>{ $("entryQty").focus(); }, 0);
  });
  $("pickerClear").addEventListener("click", ()=>{
    $("bowlerName").value="";
    $("bowlerHcp").value="";
    closePicker();
  });
  $("pickerUseManual").addEventListener("click", ()=>{
    const name=normalizeName($("pickerManualName").value);
    if(!name) return;
    const type=$("entryType").value;
    const hcp = (type==="handicap") ? $("pickerManualHcp").value : "";
    applyPickedBowler(name, hcp);
    closePicker();
    setTimeout(()=>{ $("entryQty").focus(); }, 0);
  });

  function renderAll(){
    state.brackets.forEach(br=>advanceBracketIfReady(br));
    renderKPIs();
    renderScoreSections();
    renderBrackets();
    renderTotals();
    updateHcpVisibility();
    updateManualHint();
  }

  async function init(){
    setActiveNav();
    updateHcpVisibility();
    updateManualHint();
    await loadRoster();
    renderAll();
  }
  init();
})();
</script>
</body>
</html>
