<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vista Lanes • Membership v2.3</title>

<style>
:root{
  --bg:#000;
  --panel: rgba(255,255,255,.04);
  --border: rgba(255,255,255,.10);
  --text:#d8e1ee;
  --muted:#8ea0b5;
  --danger:#ff4d4d;
  --success:#28c76f;
  --accent:#6aa7ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui;background:var(--bg);color:var(--text);}
.wrap{max-width:1200px;margin:0 auto;padding:14px;}
.brandbar{text-align:center;margin-bottom:10px;}
.brandbar img{width:min(340px,86vw);}
.menubar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:14px;}
.menubar a{text-decoration:none;background:#d9d9d9;color:#111;padding:10px 14px;border-radius:999px;font-weight:800;}
.menubar a.active{background:#cfcfcf;}
h1{margin:0 0 10px 0;font-size:22px;font-weight:900;}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:14px;}
.hd{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);}
input,select{background:#111;border:1px solid #333;color:var(--text);padding:8px 10px;border-radius:12px;}
.btn{background:rgba(106,167,255,.18);border:1px solid rgba(255,255,255,.14);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800;}
.btn.small{padding:5px 10px;font-size:12px;}
.btn.green{background:rgba(40,199,111,.18);}
.btn.red{background:rgba(255,77,77,.18);}
table{width:100%;border-collapse:collapse;}
thead th{font-size:12px;text-transform:uppercase;color:var(--muted);padding:10px;cursor:pointer;user-select:none;}
tbody td{padding:10px;border-top:1px solid rgba(255,255,255,.05);vertical-align:middle;}
.due-red{color:var(--danger);font-weight:900;}
.credit-green{color:var(--success);font-weight:900;}
.moneyCell{font-variant-numeric: tabular-nums;}
.editable{
  outline:none;
  border-radius:10px;
  padding:6px 8px;
}
.editable:focus{
  box-shadow: 0 0 0 2px rgba(106,167,255,.35);
  background: rgba(255,255,255,.05);
}
.smallNote{color:var(--muted);font-size:12px;margin-top:6px;}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;padding:14px;}
.modal-box{background:#111;border:1px solid rgba(255,255,255,.12);padding:18px;border-radius:18px;width:min(420px,96vw);}
.modal-box h3{margin:0 0 10px 0;}
.row{display:flex;gap:10px}
.row > *{flex:1}
hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0}
.logPanel{margin-top:14px}
.logHd{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.logHd .spacer{flex:1}
.logTableWrap{max-height:320px;overflow:auto;border:1px solid rgba(255,255,255,.10);border-radius:14px}
.logTableWrap table{min-width:860px}
code.k{color:#ffd166}
</style>
</head>

<body>
<div class="wrap">
  <div class="brandbar">
    <img src="assets/9AB9725D-AD71-4DDC-BE9B-03328F663643.png" alt="Vista Lanes">
  </div>

  <nav class="menubar">
    <a href="index.html">Home</a>
    <a href="bowlers.html">Bowlers</a>
    <a href="leagues.html">Leagues</a>
    <a href="teams.html">Teams</a>
    <a href="lanes.html">Lanes</a>
    <a href="brackets.html">Brackets</a>
    <a href="payouts.html">Payouts</a>
    <a class="active" href="membership.html">Membership</a>
    <a href="tournaments.html">Tournaments</a>
  </nav>

  <h1>Membership</h1>

  <div class="panel">
    <div class="hd">
      <div class="pill"><b id="count">0</b> members</div>
      <select id="leagueSelect"></select>
      <input id="search" placeholder="Search bowler..." />
      <button class="btn" id="weeklyBtn">Apply Weekly Dues</button>
      <button class="btn green" id="saveBtn">Save CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th onclick="sortBy('last_name')">Last Name</th>
          <th onclick="sortBy('first_name')">First Name</th>
          <th onclick="sortBy('dues_owed_to_date')">Dues Owed</th>
          <th onclick="sortBy('upcoming_dues')">Upcoming</th>
          <th onclick="sortBy('credits')">Credits</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="smallNote">
      Tip: click a money cell to edit (type a number, press outside). Weekly dues default adds to <code class="k">upcoming_dues</code> unless you choose otherwise.
    </div>

    <div class="logPanel">
      <hr>
      <div class="logHd">
        <div class="pill"><b id="logCount">0</b> log entries</div>
        <div class="spacer"></div>
        <button class="btn" id="exportLogBtn">Export Log</button>
        <button class="btn red" id="clearLogBtn">Clear Log</button>
      </div>
      <div class="logTableWrap">
        <table>
          <thead>
            <tr>
              <th style="cursor:default">Time</th>
              <th style="cursor:default">Bowler</th>
              <th style="cursor:default">Action</th>
              <th style="cursor:default">Amount</th>
              <th style="cursor:default">Method</th>
              <th style="cursor:default">Notes</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="modal" style="display:none;"></div>

<script>
let rows=[];
let sortKey="last_name";
let sortAsc=true;

const STORAGE_KEY="vista_selected_league_id";

function logKey(leagueId){ return `vista_membership_paylog_${leagueId}`; }

function safeNum(x){
  const n = parseFloat(String(x ?? "").replace(/[^0-9.-]/g,''));
  return isFinite(n) ? n : 0;
}
function money(n){ return '$' + (Math.round(safeNum(n)*100)/100).toFixed(2); }

function parseCSV(text){
  // simple CSV (no quoted commas) - matches your existing files
  const lines=text.trim().split('\n').filter(Boolean);
  const headers=lines[0].split(',');
  return lines.slice(1).map(l=>{
    const vals=l.split(',');
    let obj={};
    headers.forEach((h,i)=>obj[h.trim()]=(vals[i] ?? '').trim());
    return obj;
  });
}

function getLeagueId(){
  return document.getElementById('leagueSelect').value;
}

function rowId(r){
  return `${(r.first_name||'').trim()}|${(r.last_name||'').trim()}`;
}
function findRowById(id){
  return rows.find(r => rowId(r) === id);
}

function loadLog(){
  const league = getLeagueId();
  try{
    const raw = localStorage.getItem(logKey(league));
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveLog(arr){
  const league = getLeagueId();
  localStorage.setItem(logKey(league), JSON.stringify(arr));
}
function addLog(entry){
  const arr = loadLog();
  arr.unshift(entry); // newest first
  // keep it reasonable
  if(arr.length > 2000) arr.length = 2000;
  saveLog(arr);
  renderLog();
}
function renderLog(){
  const arr = loadLog();
  document.getElementById('logCount').innerText = arr.length;
  const body = document.getElementById('logBody');
  body.innerHTML = '';
  const show = arr.slice(0, 200); // show latest 200
  show.forEach(e => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.ts || ''}</td>
      <td>${e.bowler || ''}</td>
      <td>${e.action || ''}</td>
      <td class="moneyCell">${e.amount || ''}</td>
      <td>${e.method || ''}</td>
      <td>${e.notes || ''}</td>
    `;
    body.appendChild(tr);
  });
}

async function loadLeagues(){
  const res=await fetch('data/leagues.csv', {cache:'no-store'});
  const txt=await res.text();
  const data=parseCSV(txt);
  const sel=document.getElementById('leagueSelect');
  sel.innerHTML='';
  data.forEach(l=>{
    const opt=document.createElement('option');
    opt.value=l.league_id;
    opt.textContent=l.league_id+' — '+l.name;
    sel.appendChild(opt);
  });
  const saved=localStorage.getItem(STORAGE_KEY)||data[0].league_id;
  sel.value=saved;
  sel.onchange=()=>{
    localStorage.setItem(STORAGE_KEY, sel.value);
    load();
  };
}

async function load(){
  const league=getLeagueId();
  const res=await fetch(`data/membership_${league}.csv`, {cache:'no-store'});
  const txt=await res.text();
  rows=parseCSV(txt);
  // normalize numeric fields
  rows.forEach(r=>{
    r.dues_owed_to_date = safeNum(r.dues_owed_to_date);
    r.upcoming_dues = safeNum(r.upcoming_dues);
    r.credits = safeNum(r.credits);
  });
  render();
  renderLog();
}

function render(){
  const q=(document.getElementById('search').value||'').toLowerCase().trim();
  let filtered = rows.filter(r=>
    (r.first_name||'').toLowerCase().includes(q) ||
    (r.last_name||'').toLowerCase().includes(q)
  );

  filtered.sort((a,b)=>{
    let v1=a[sortKey], v2=b[sortKey];
    if(sortKey === 'first_name' || sortKey === 'last_name'){
      v1=(v1||'').toString().toLowerCase();
      v2=(v2||'').toString().toLowerCase();
    }else{
      v1=safeNum(v1); v2=safeNum(v2);
    }
    if(v1<v2) return sortAsc?-1:1;
    if(v1>v2) return sortAsc?1:-1;
    return 0;
  });

  const tbody=document.getElementById('tbody');
  tbody.innerHTML='';

  filtered.forEach(r=>{
    const id = rowId(r);
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.last_name || ''}</td>
      <td>${r.first_name || ''}</td>

      <td class="moneyCell">
        <div class="editable ${safeNum(r.dues_owed_to_date)>0 ? 'due-red' : ''}" contenteditable="true"
             data-row="${id}" data-field="dues_owed_to_date">${money(r.dues_owed_to_date)}</div>
      </td>

      <td class="moneyCell">
        <div class="editable" contenteditable="true" data-row="${id}" data-field="upcoming_dues">${money(r.upcoming_dues)}</div>
      </td>

      <td class="moneyCell">
        <div class="editable ${safeNum(r.credits)>0 ? 'credit-green' : ''}" contenteditable="true"
             data-row="${id}" data-field="credits">${money(r.credits)}</div>
      </td>

      <td><button class="btn small" onclick="openPayment('${id.replace(/'/g, "\\'")}')">Pay</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('count').innerText = filtered.length;

  // attach blur handlers for editable cells
  tbody.querySelectorAll('.editable[contenteditable="true"]').forEach(el=>{
    el.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); el.blur(); }
    });
    el.addEventListener('blur', ()=>{
      const rid = el.getAttribute('data-row');
      const field = el.getAttribute('data-field');
      const val = safeNum(el.innerText);
      const rr = findRowById(rid);
      if(!rr) return;
      rr[field] = Math.max(0, val);
      render(); // re-render to re-apply colors/format
    }, {once:true});
  });
}

function sortBy(key){
  if(sortKey===key) sortAsc=!sortAsc;
  else {sortKey=key; sortAsc=true;}
  render();
}

function openModal(innerHtml){
  const modal=document.getElementById('modal');
  modal.innerHTML = `<div class="modal"><div class="modal-box">${innerHtml}</div></div>`;
  modal.style.display='block';
  modal.querySelector('.modal').addEventListener('click', (e)=>{
    if(e.target.classList.contains('modal')) closeModal();
  });
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

function openPayment(rid){
  const r = findRowById(rid);
  if(!r) return;
  const bowler = `${r.first_name||''} ${r.last_name||''}`.trim();
  openModal(`
    <h3>Payment • ${bowler}</h3>
    <div class="row">
      <input id="pAmt" type="number" step="0.01" min="0" placeholder="Amount" />
      <select id="pTarget">
        <option value="dues">Apply to Current Dues</option>
        <option value="upcoming">Apply to Upcoming</option>
        <option value="credit">Add Credit</option>
        <option value="useCreditToDues">Use Credit → Pay Dues</option>
      </select>
    </div>
    <div style="margin-top:10px">
      <select id="pMethod" style="width:100%">
        <option value="cash">Cash</option>
        <option value="card">Card</option>
        <option value="credit_transfer">Credit Transfer</option>
      </select>
    </div>
    <div style="margin-top:10px">
      <input id="pNote" placeholder="Notes (optional)" style="width:100%" />
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn green" onclick="applyPayment('${rid.replace(/'/g,"\\'")}')">Apply</button>
    </div>
  `);
}

function applyPayment(rid){
  const r = findRowById(rid);
  if(!r) return;
  const amt = safeNum(document.getElementById('pAmt').value);
  if(!(amt > 0)){ alert('Enter an amount > 0'); return; }
  const target = document.getElementById('pTarget').value;
  const method = document.getElementById('pMethod').value;
  const note = (document.getElementById('pNote').value || '').trim();
  const bowler = `${r.first_name||''} ${r.last_name||''}`.trim();

  if(target === 'dues'){
    r.dues_owed_to_date = Math.max(0, safeNum(r.dues_owed_to_date) - amt);
    addLog({ts:new Date().toLocaleString(), bowler, action:'Payment → Current Dues', amount: money(amt), method, notes: note});
  }else if(target === 'upcoming'){
    r.upcoming_dues = Math.max(0, safeNum(r.upcoming_dues) - amt);
    addLog({ts:new Date().toLocaleString(), bowler, action:'Payment → Upcoming', amount: money(amt), method, notes: note});
  }else if(target === 'credit'){
    r.credits = Math.max(0, safeNum(r.credits) + amt);
    addLog({ts:new Date().toLocaleString(), bowler, action:'Add Credit', amount: money(amt), method, notes: note});
  }else if(target === 'useCreditToDues'){
    const avail = safeNum(r.credits);
    if(avail < amt){ alert(`Not enough credit. Available: ${money(avail)}`); return; }
    r.credits = Math.max(0, avail - amt);
    r.dues_owed_to_date = Math.max(0, safeNum(r.dues_owed_to_date) - amt);
    addLog({ts:new Date().toLocaleString(), bowler, action:'Use Credit → Pay Dues', amount: money(amt), method:'credit_transfer', notes: note});
  }

  closeModal();
  render();
}

function openWeeklyDues(){
  openModal(`
    <h3>Apply Weekly Dues (All Members)</h3>
    <div class="row">
      <input id="wAmt" type="number" step="0.01" min="0" placeholder="Weekly amount" />
      <select id="wTarget">
        <option value="upcoming">Add to Upcoming Dues</option>
        <option value="dues">Add to Current Dues</option>
      </select>
    </div>
    <div style="margin-top:10px">
      <input id="wNote" placeholder="Notes (optional) e.g., Week 5 dues" style="width:100%" />
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn green" onclick="applyWeeklyDues()">Apply</button>
    </div>
  `);
}

function applyWeeklyDues(){
  const amt = safeNum(document.getElementById('wAmt').value);
  if(!(amt > 0)){ alert('Enter an amount > 0'); return; }
  const target = document.getElementById('wTarget').value;
  const note = (document.getElementById('wNote').value || '').trim();
  const ts = new Date().toLocaleString();

  rows.forEach(r=>{
    const bowler = `${r.first_name||''} ${r.last_name||''}`.trim();
    if(target === 'upcoming'){
      r.upcoming_dues = safeNum(r.upcoming_dues) + amt;
      addLog({ts, bowler, action:'Weekly Dues → Upcoming', amount: money(amt), method:'system', notes: note});
    }else{
      r.dues_owed_to_date = safeNum(r.dues_owed_to_date) + amt;
      addLog({ts, bowler, action:'Weekly Dues → Current', amount: money(amt), method:'system', notes: note});
    }
  });

  closeModal();
  render();
}

function exportCSV(){
  if(!rows.length){ alert('No rows loaded'); return; }
  const league = getLeagueId();
  const headers = ['first_name','last_name','dues_owed_to_date','upcoming_dues','credits'];
  const body = rows.map(r => [
    (r.first_name||'').trim(),
    (r.last_name||'').trim(),
    safeNum(r.dues_owed_to_date).toFixed(2),
    safeNum(r.upcoming_dues).toFixed(2),
    safeNum(r.credits).toFixed(2),
  ].join(',')).join('\n');
  const csv = headers.join(',') + '\n' + body + '\n';
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`membership_${league}.csv`;
  a.click();
}

function exportLog(){
  const league = getLeagueId();
  const arr = loadLog();
  const headers = ['ts','bowler','action','amount','method','notes'];
  const body = arr.map(e => headers.map(h => {
    const s = String(e[h] ?? '');
    // basic CSV escape
    return /[",\n\r]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }).join(',')).join('\n');
  const csv = headers.join(',') + '\n' + body + '\n';
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`membership_payment_log_${league}.csv`;
  a.click();
}

function clearLog(){
  const league = getLeagueId();
  if(!confirm('Clear payment log for this league?')) return;
  localStorage.removeItem(logKey(league));
  renderLog();
}

document.getElementById('search').addEventListener('input', render);
document.getElementById('saveBtn').addEventListener('click', exportCSV);
document.getElementById('weeklyBtn').addEventListener('click', openWeeklyDues);
document.getElementById('exportLogBtn').addEventListener('click', exportLog);
document.getElementById('clearLogBtn').addEventListener('click', clearLog);

loadLeagues().then(load);
</script>
</body>
</html>
