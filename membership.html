<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Vista Lanes - Membership</title>

<style>
:root{
  --bg:#000;
  --border:rgba(255,255,255,.08);
  --text:#d8e1ee;
  --muted:#8ea0b5;
  --shadow: 0 10px 30px rgba(0,0,0,.45);
  --radius:18px;

  --panelBg: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
  --cardBg: rgba(255,255,255,.04);
  --chipBg: rgba(255,255,255,.10);

  --good:#35d07f;
  --bad:#ff4d4d;
  --warn:#ffd166;

  --btnBg:#d9d9d9;
  --btnText:#000;
  --btnBorder:rgba(0,0,0,.18);

  --accent:#3aa3ff;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background:var(--bg);
  color:var(--text);

  height:100svh;
  height:100dvh;
  overflow:hidden;            /* page does not scroll */
  display:flex;
  flex-direction:column;
}

.wrap{
  width:100%;
  max-width:980px;
  margin:0 auto;
  padding:0 14px env(safe-area-inset-bottom);
  flex:1;
  display:flex;
  flex-direction:column;
  min-height:0;
}

/* ================= LOGO ================= */

.brandArea{
  display:flex;
  justify-content:center;
  align-items:center;
  line-height:0;
  flex:0 0 auto;
}

.brandCrop{
  width:min(720px,96vw);
  height:clamp(190px,26svh,260px);
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}

.brandMain{
  width:100%;
  height:auto;
  display:block;
  object-fit:contain;
  transform: translateY(8px) scale(1);
  transform-origin:center;
  filter: drop-shadow(0 14px 28px rgba(0,0,0,.60));
}

/* ================= PANEL ================= */

.panel{
  margin-top:4px;
  background:var(--panelBg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  flex:1 1 auto;
  min-height:0;
  display:flex;
  flex-direction:column;
}

.hd{
  padding:12px 16px 10px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

.hdLeft{ display:flex; flex-direction:column; gap:8px; min-width:0; }

.hd h1{
  margin:0;
  font-size:20px;
  font-weight:900;
}

.subRow{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

.sub{
  color:var(--muted);
  font-size:13px;
}

.backBtn{
  flex:0 0 auto;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--text);
  text-decoration:none;
  font-weight:900;
  font-size:14px;
  user-select:none;
}
.backBtn:active{ transform: translateY(1px); }

/* Body scrolls */
.bd{
  padding:12px;
  flex:1 1 auto;
  min-height:0;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}

/* ================= CONTROLS ================= */

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  margin:2px 0 12px;
}

.ctrlLeft{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.ctrlRight{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

.select{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-weight:900;
  font-size:13px;
}

.select label{ color:var(--muted); font-weight:900; }
.select select{
  background:transparent;
  color:var(--text);
  border:none;
  outline:none;
  font-weight:900;
  font-size:13px;
  max-width:240px;
}

.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.08);
  color: var(--text);
  text-decoration:none;
  font-weight:950;
  font-size:13px;
  user-select:none;
  white-space:nowrap;
}
.btn:active{ transform: translateY(1px); }

.btnPrimary{
  background: rgba(58,163,255,.18);
  border-color: rgba(58,163,255,.35);
}

.btnDanger{
  background: rgba(255,77,77,.14);
  border-color: rgba(255,77,77,.28);
}

/* ================= TABLE ================= */

.tableWrap{
  border:1px solid rgba(255,255,255,.10);
  background: var(--cardBg);
  border-radius:16px;
  overflow:hidden;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed; /* prevents sideways scroll */
}

thead th{
  text-align:left;
  font-size:12px;
  color:var(--muted);
  font-weight:950;
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.02);
}

tbody td{
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,.06);
  vertical-align:middle;
  font-size:13px;
}

tbody tr:last-child td{ border-bottom:none; }

.colName{ width:34%; }
.colOwed{ width:18%; }
.colUpcoming{ width:18%; }
.colCredits{ width:18%; }
.colActions{ width:12%; text-align:right; }

.money{
  font-variant-numeric: tabular-nums;
  font-weight:950;
}

.bad{ color: var(--bad); }
.good{ color: var(--good); }
.warn{ color: var(--warn); }

.smallBtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.08);
  color: var(--text);
  text-decoration:none;
  font-weight:950;
  font-size:12px;
  user-select:none;
}
.smallBtn:active{ transform: translateY(1px); }

/* ================= MODAL ================= */

.modalBackdrop{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:999;
}

.modal{
  width:min(720px, 96vw);
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(10,10,10,.92);
  box-shadow: 0 18px 50px rgba(0,0,0,.70);
  overflow:hidden;
}

.modalHd{
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.modalHd h3{
  margin:0;
  font-size:15px;
  font-weight:950;
}

.xBtn{
  width:38px; height:38px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-weight:950;
  cursor:pointer;
}

.modalBd{ padding:14px; }

.formGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.field label{
  color:var(--muted);
  font-size:12px;
  font-weight:950;
}

.field input, .field select{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-weight:900;
  outline:none;
}

.fieldFull{ grid-column: 1 / -1; }

.note{
  color:var(--muted);
  font-size:12px;
  line-height:1.35;
  margin:0;
}

.modalFt{
  padding:12px 14px;
  border-top:1px solid rgba(255,255,255,.10);
  display:flex;
  gap:10px;
  justify-content:flex-end;
}

@media (max-width:640px){
  .formGrid{ grid-template-columns: 1fr; }
}

/* ================= BOTTOM ================= */

.bottomArea{
  flex:0 0 auto;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  padding:10px 0 0;
}

.poweredByWrap{
  display:flex;
  align-items:center;
  gap:10px;
}

.poweredByText{
  color:var(--muted);
  font-size:12px;
  font-weight:800;
  text-transform:uppercase;
}

.poweredByLogo{
  width:118px;
  height:auto;
  filter:drop-shadow(0 8px 18px rgba(0,0,0,.55));
}

footer{
  width:100%;
  text-align:center;
  font-size:12px;
  color:var(--muted);
  padding:6px 0 10px;
  border-top:1px solid var(--border);
}

/* Tighten for shorter screens */
@media (max-height:760px){
  .brandCrop{ height:clamp(165px,24svh,220px); }
  .brandMain{ transform: translateY(6px) scale(1); }
  .poweredByLogo{ width:100px; }
}
@media (max-height:700px){
  .brandCrop{ height:clamp(145px,22svh,200px); }
}
</style>
</head>

<body>
<div class="wrap">

  <!-- LOGO -->
  <div class="brandArea">
    <div class="brandCrop">
      <img
        class="brandMain"
        src="assets/9AB9725D-AD71-4DDC-BE9B-03328F663643.png"
        alt="Vista Lanes"
      />
    </div>
  </div>

  <!-- PANEL -->
  <div class="panel">
    <div class="hd">
      <div class="hdLeft">
        <h1>Membership</h1>
        <div class="subRow">
          <div class="sub">Loaded from <span style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;" id="fileLabel">data/membership_?.csv</span></div>
        </div>
      </div>

      <a class="backBtn" href="index.html">‚Üê Back</a>
    </div>

    <div class="bd">

      <div class="controls">
        <div class="ctrlLeft">
          <div class="select">
            <label for="leagueSelect">League:</label>
            <select id="leagueSelect"></select>
          </div>
</div>

        <div class="ctrlRight">
          <a class="btn btnPrimary" href="#" id="addBowlerBtn">‚ûï Add Bowler</a>
          <a class="btn" href="#" id="exportBtn">‚¨áÔ∏è Export CSV</a>
          <a class="btn btnDanger" href="#" id="resetBtn">üóëÔ∏è Reset Local Changes</a>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="colName">Bowler</th>
              <th class="colOwed">Dues Owed</th>
              <th class="colUpcoming">Upcoming Dues</th>
              <th class="colCredits">Credits</th>
              <th class="colActions">Payment</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <p class="note" style="margin-top:10px;">
        This page is offline/static-friendly: payments update the table and are saved in your browser (localStorage).
        Use <b>Export CSV</b> to download the updated membership file and replace it on the Pi.
      </p>

    </div>
  </div>

  <!-- BOTTOM -->
  <div class="bottomArea">
    <div class="poweredByWrap">
      <div class="poweredByText">Powered By</div>
      <img
        class="poweredByLogo"
        src="assets/68D8CA4C-741E-41E1-ABBC-8B57D7FD0A57.png"
        alt="Myles Bowling Systems"
      />
    </div>

    <footer>
      ¬© <span id="year"></span> Vista Lanes. All Rights Reserved.
    </footer>
  </div>

</div>

<!-- PAYMENT MODAL -->
<div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHd">
      <h3 id="modalTitle">Make Payment</h3>
      <button class="xBtn" id="closeModalBtn" aria-label="Close">‚úï</button>
    </div>
    <div class="modalBd">
      <div class="formGrid">

        <div class="field fieldFull">
          <label>Bowler</label>
          <input id="mBowler" type="text" readonly />
        </div>

        <div class="field">
          <label>Entry Type</label>
          <select id="mType">
            <option value="dues">Dues</option>
            <option value="credit">Credit</option>
          </select>
        </div>

        <div class="field">
          <label>Amount</label>
          <input id="mAmount" type="number" step="0.01" min="0" />
        </div>

        <div class="field fieldFull" id="methodWrap">
          <label>Payment Method (for dues)</label>
          <select id="mMethod">
            <option value="use_credit">Use Credit (if available)</option>
            <option value="cash">Cash</option>
            <option value="card">Card</option>
          </select>
          <p class="note" id="methodNote" style="margin-top:6px;"></p>
        </div>

        <div class="field fieldFull">
          <label>Notes (optional)</label>
          <input id="mNote" type="text" placeholder="Example: Paid week 3 dues, $5 credit applied" />
        </div>

      </div>
    </div>
    <div class="modalFt">
      <a class="btn" href="#" id="cancelBtn">Cancel</a>
      <a class="btn btnPrimary" href="#" id="savePaymentBtn">Save</a>
    </div>
  </div>
</div>


<script>
(() => {
  const LEAGUES_PATH = "data/leagues.csv"; // same as bowlers.html
  const DEFAULT_LEAGUE_ID = "32170";       // change if you want a different default league
  const STORAGE_KEY = "vista_selected_league_id";

  const $ = (id) => document.getElementById(id);

  const COLS = ["bowler_name","dues_owed_to_date","upcoming_dues","credits"];

  let rows = [];      // array of objects
  let headers = COLS; // fixed for membership files

  function splitCSVLine(line){
    const res=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c === '"'){
        if(q && line[i+1] === '"'){ cur+='"'; i++; }
        else q=!q;
      } else if(c === ',' && !q){
        res.push(cur); cur="";
      } else cur+=c;
    }
    res.push(cur);
    return res;
  }

  function parseCSV(text){
    const lines = text.replace(/
/g,"
").replace(//g,"
").split("
").filter(l=>l.trim()!=="");
    if(!lines.length) return {headers:[], rows:[]};

    const header = splitCSVLine(lines[0]).map(h=>h.trim());
    const out=[];
    for(let i=1;i<lines.length;i++){
      const cols = splitCSVLine(lines[i]);
      const obj = {};
      header.forEach((h,idx)=> obj[h] = (cols[idx] ?? "").trim());
      out.push(obj);
    }
    return {headers: header, rows: out};
  }

  function csvEscape(val){
    const s = String(val ?? "");
    if(/[",
]/.test(s)){
      return '"' + s.replace(/"/g,'""') + '"';
    }
    return s;
  }

  function toCSV(headers, rows){
    const head = headers.map(csvEscape).join(",");
    const body = rows.map(r => headers.map(h => csvEscape(r[h] ?? "")).join(",")).join("
");
    return head + "
" + body + "
";
  }

  function clampMoney(n){
    const x = Number(n || 0);
    if(!isFinite(x)) return 0;
    return Math.round(x * 100) / 100;
  }

  function money(n){
    const x = clampMoney(n);
    return x.toFixed(2);
  }

  function getSelectedLeagueId(){
    const v = $("leagueSelect").value || "";
    return v || DEFAULT_LEAGUE_ID;
  }

  function currentCsvPath(){
    const leagueId = getSelectedLeagueId();
    return `data/membership_${leagueId}.csv`;
  }

  function updateLoadedPathLabel(){
    const el = document.getElementById("fileLabel");
    if(el) el.textContent = currentCsvPath();
  }

  /* =========================
     RENDER TABLE
  ========================= */

  function moneyClassForOwed(v){
    const n = clampMoney(v);
    if(n > 0.01) return "bad";
    return "good";
  }

  function render(){
    const tbody = $("rows");
    tbody.innerHTML = "";

    rows.forEach((r, idx) => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.className = "colName";
      tdName.textContent = r.bowler_name || "";
      tr.appendChild(tdName);

      const tdOwed = document.createElement("td");
      tdOwed.className = "colOwed money " + moneyClassForOwed(r.dues_owed_to_date);
      tdOwed.textContent = `$${money(r.dues_owed_to_date)}`;
      tr.appendChild(tdOwed);

      const tdUpcoming = document.createElement("td");
      tdUpcoming.className = "colUpcoming money warn";
      tdUpcoming.textContent = `$${money(r.upcoming_dues)}`;
      tr.appendChild(tdUpcoming);

      const tdCredits = document.createElement("td");
      tdCredits.className = "colCredits money " + (clampMoney(r.credits) > 0 ? "good" : "muted");
      tdCredits.textContent = `$${money(r.credits)}`;
      tr.appendChild(tdCredits);

      const tdAct = document.createElement("td");
      tdAct.className = "colActions";

      const btn = document.createElement("a");
      btn.href = "#";
      btn.className = "smallBtn";
      btn.textContent = "üí≥ Pay";
      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        openModal(idx);
      });

      tdAct.appendChild(btn);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });
  }

  /* =========================
     LOAD MEMBERSHIP CSV
  ========================= */

  async function loadMembership(){
    $("err")?.style && ($("err").style.display = "none");
    updateLoadedPathLabel();

    try{
      const path = currentCsvPath();
      const res = await fetch(path, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);

      const text = await res.text();
      const parsed = parseCSV(text);

      // If file is empty/missing header, fall back to fixed headers
      const fileHeaders = parsed.headers.length ? parsed.headers : COLS;

      // Map to our fixed columns
      const lower = fileHeaders.map(h => (h||"").toLowerCase());
      const idx = {
        bowler_name: lower.indexOf("bowler_name"),
        dues_owed_to_date: lower.indexOf("dues_owed_to_date"),
        upcoming_dues: lower.indexOf("upcoming_dues"),
        credits: lower.indexOf("credits"),
      };

      rows = parsed.rows.map(obj => {
        const out = {
          bowler_name: (idx.bowler_name >= 0 ? (obj[fileHeaders[idx.bowler_name]]||"") : "").trim(),
          dues_owed_to_date: clampMoney(idx.dues_owed_to_date >= 0 ? obj[fileHeaders[idx.dues_owed_to_date]] : 0),
          upcoming_dues: clampMoney(idx.upcoming_dues >= 0 ? obj[fileHeaders[idx.upcoming_dues]] : 0),
          credits: clampMoney(idx.credits >= 0 ? obj[fileHeaders[idx.credits]] : 0),
        };
        return out;
      }).filter(r => r.bowler_name);

      // Sort by last name-ish
      rows.sort((a,b)=> (a.bowler_name||"").localeCompare(b.bowler_name||""));

      render();
    }catch(e){
      rows = [{
        bowler_name: `Could not load ${currentCsvPath()}`,
        dues_owed_to_date: 0,
        upcoming_dues: 0,
        credits: 0
      }];
      render();
      const errEl = $("err");
      if(errEl){
        errEl.style.display = "block";
        errEl.textContent = String(e && e.message ? e.message : e);
      } else {
        alert(String(e && e.message ? e.message : e));
      }
    }
  }

  /* =========================
     PAYMENTS (modal)
  ========================= */

  let activeIdx = -1;

  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const savePaymentBtn = document.getElementById("savePaymentBtn");

  const mBowler = document.getElementById("mBowler");
  const mType = document.getElementById("mType");
  const mAmount = document.getElementById("mAmount");
  const methodWrap = document.getElementById("methodWrap");
  const mMethod = document.getElementById("mMethod");
  const methodNote = document.getElementById("methodNote");
  const mNote = document.getElementById("mNote");

  function openModal(idx){
    activeIdx = idx;
    const r = rows[idx];
    mBowler.value = r.bowler_name || "";
    mType.value = "dues";
    mAmount.value = Math.max(0, clampMoney(r.dues_owed_to_date || 0)).toFixed(2);
    mMethod.value = "use_credit";
    mNote.value = "";
    updateMethodVisibility();
    updateMethodNote();
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden","false");
  }

  function closeModal(){
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden","true");
    activeIdx = -1;
  }

  function updateMethodVisibility(){
    const isDues = (mType.value === "dues");
    methodWrap.style.display = isDues ? "block" : "none";
  }

  function updateMethodNote(){
    if(activeIdx < 0) return;
    const r = rows[activeIdx];
    const credits = clampMoney(r.credits || 0);
    if(mType.value !== "dues"){
      methodNote.textContent = "Adding credit increases the bowler‚Äôs available credit balance.";
      return;
    }
    if(mMethod.value === "use_credit"){
      methodNote.textContent = credits > 0
        ? `This bowler has $${money(credits)} credit available. We'll apply as much as needed.`
        : "This bowler has $0.00 credit available. If you save, it will still reduce dues, but credit won't apply.";
    }else if(mMethod.value === "cash"){
      methodNote.textContent = "Cash payment reduces dues owed.";
    }else{
      methodNote.textContent = "Card payment reduces dues owed.";
    }
  }

  closeModalBtn.addEventListener("click", (e)=>{ e.preventDefault(); closeModal(); });
  cancelBtn.addEventListener("click", (e)=>{ e.preventDefault(); closeModal(); });
  modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });

  mType.addEventListener("change", ()=>{ updateMethodVisibility(); updateMethodNote(); });
  mMethod.addEventListener("change", updateMethodNote);

  savePaymentBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    if(activeIdx < 0) return;

    const r = rows[activeIdx];
    const type = mType.value;
    const amount = clampMoney(mAmount.value);

    if(!(amount > 0)){
      alert("Enter an amount greater than 0.");
      return;
    }

    if(type === "credit"){
      r.credits = clampMoney((r.credits||0) + amount);
    }else{
      const method = mMethod.value;
      if(method === "use_credit"){
        const creditsAvail = clampMoney(r.credits || 0);
        const apply = Math.min(creditsAvail, amount);
        r.credits = clampMoney(creditsAvail - apply);
        r.dues_owed_to_date = clampMoney((r.dues_owed_to_date||0) - amount);
      }else{
        r.dues_owed_to_date = clampMoney((r.dues_owed_to_date||0) - amount);
      }
    }

    closeModal();
    render();
  });

  /* =========================
     EXPORT
  ========================= */

  document.getElementById("exportBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    const csvText = toCSV(headers, rows.map(r => ({
      bowler_name: r.bowler_name || "",
      dues_owed_to_date: money(r.dues_owed_to_date || 0),
      upcoming_dues: money(r.upcoming_dues || 0),
      credits: money(r.credits || 0)
    })));
    const leagueId = getSelectedLeagueId();
    const filename = `membership_${leagueId}.csv`;

    const blob = new Blob([csvText], {type: "text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  });

  /* =========================
     ADD BOWLER
  ========================= */

  document.getElementById("addBowlerBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    const name = prompt("Enter bowler name:");
    if(!name) return;
    const clean = name.trim();
    if(!clean) return;
    if(rows.some(x => (x.bowler_name||"").toLowerCase() === clean.toLowerCase())){
      alert("That bowler already exists in this membership file.");
      return;
    }
    rows.push({
      bowler_name: clean,
      dues_owed_to_date: 0,
      upcoming_dues: 0,
      credits: 0
    });
    rows.sort((a,b)=> (a.bowler_name||"").localeCompare(b.bowler_name||""));
    render();
  });

  /* =========================
     LEAGUE DROPDOWN (copied from bowlers.html logic)
  ========================= */

  function setLeagueOptions(options, selectedId){
    const sel = $("leagueSelect");
    sel.innerHTML = "";

    options.forEach(o => {
      const opt = document.createElement("option");
      opt.value = o.league_id;
      opt.textContent = `${o.league_id} ‚Äî ${o.name}`;
      sel.appendChild(opt);
    });

    const exists = options.some(o => String(o.league_id) === String(selectedId));
    sel.value = exists ? selectedId : (options[0]?.league_id || DEFAULT_LEAGUE_ID);
  }

  async function loadLeagues(){
    const saved = localStorage.getItem(STORAGE_KEY) || DEFAULT_LEAGUE_ID;

    try{
      const res = await fetch(LEAGUES_PATH, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();
      const parsed = parseCSV(text);

      const h = parsed.headers.map(x => x.toLowerCase());
      const idxId = h.indexOf("league_id");
      const idxName = h.indexOf("name");

      if(idxId < 0 || idxName < 0) throw new Error("leagues.csv missing league_id or name headers");

      const options = parsed.rows
        .map(r => ({
          league_id: (r[parsed.headers[idxId]] || "").trim(),
          name: (r[parsed.headers[idxName]] || "").trim()
        }))
        .filter(o => o.league_id);

      if(!options.length) throw new Error("No leagues found in leagues.csv");

      setLeagueOptions(options, saved);

    }catch(_e){
      setLeagueOptions([{league_id: DEFAULT_LEAGUE_ID, name: "League"}], saved);
    }

    $("leagueSelect").addEventListener("change", () => {
      localStorage.setItem(STORAGE_KEY, getSelectedLeagueId());
      loadMembership();
    });
  }

  document.getElementById("resetBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    alert("This Membership page is file-based like bowlers.html. Use Export CSV after updates, then replace the file on the Pi.");
  });

  // year
  document.getElementById("year").textContent = new Date().getFullYear();

  // init
  loadLeagues().then(loadMembership);
})();
</script>


</body>
</html>
