<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vista Lanes • Membership</title>

<link rel="stylesheet" href="styles.css"/>
</head>

<body>

<header>
  <img src="assets/logo.png" class="logo"/>
</header>

<nav class="menu">
  <a href="index.html">Home</a>
  <a href="bowlers.html">Bowlers</a>
  <a href="leagues.html">Leagues</a>
  <a href="teams.html">Teams</a>
  <a href="lanes.html">Lanes</a>
  <a href="brackets.html">Brackets</a>
  <a href="payouts.html">Payouts</a>
  <a class="active" href="membership.html">Membership</a>
  <a href="tournaments.html">Tournaments</a>
</nav>

<main>

<h1>Membership</h1>
<div class="sub">
  Loaded from <b id="loadedPath">data/membership_32170.csv</b>
</div>

<div class="card">

  <div class="toolbar">

    <div class="pill">
      <span id="count">0</span>
      <span>members</span>
    </div>

    <select id="leagueSelect"></select>

    <input type="text" id="search" placeholder="Search member..."/>

    <button class="btn" id="reload">Reload CSV</button>

  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>BOWLER</th>
          <th>DUES OWED</th>
          <th>UPCOMING DUES</th>
          <th>CREDITS</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div id="err" class="err" style="display:none"></div>

</div>

</main>

<script>
(() => {

const LEAGUES_PATH = "data/leagues.csv";
const DEFAULT_LEAGUE_ID = "32170";
const STORAGE_KEY = "vista_selected_league_id";

const $ = id => document.getElementById(id);

let rows = [];

function splitCSV(line){
  const res=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c === '"'){
      if(q && line[i+1] === '"'){ cur+='"'; i++; }
      else q=!q;
    } else if(c === ',' && !q){
      res.push(cur); cur="";
    } else cur+=c;
  }
  res.push(cur);
  return res;
}

function parseCSV(text){
  const lines=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n")
  .split("\n").filter(l=>l.trim()!=="");

  if(!lines.length) return {headers:[], rows:[]};

  const headers=splitCSV(lines[0]).map(h=>h.trim());
  const out=[];

  for(let i=1;i<lines.length;i++){
    const cols=splitCSV(lines[i]);
    const obj={};
    headers.forEach((h,idx)=>obj[h]=cols[idx]||"");
    out.push(obj);
  }

  return {headers, rows:out};
}

function getLeague(){
  return $("leagueSelect").value || DEFAULT_LEAGUE_ID;
}

function currentPath(){
  return `data/membership_${getLeague()}.csv`;
}

function updatePath(){
  $("loadedPath").textContent=currentPath();
}

function render(){
  const q=($("search").value||"").toLowerCase();
  let filtered=rows.slice();

  if(q){
    filtered=filtered.filter(r =>
      JSON.stringify(r).toLowerCase().includes(q)
    );
  }

  $("count").textContent=filtered.length;

  const tbody=$("tbody");
  tbody.innerHTML="";

  filtered.forEach(r=>{
    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td>${r.bowler_name||""}</td>
      <td>$${Number(r.dues_owed_to_date||0).toFixed(2)}</td>
      <td>$${Number(r.upcoming_dues||0).toFixed(2)}</td>
      <td>$${Number(r.credits||0).toFixed(2)}</td>
    `;

    tbody.appendChild(tr);
  });
}

async function load(){

  $("err").style.display="none";

  try{
    updatePath();
    const res=await fetch(currentPath(),{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);

    const text=await res.text();
    const parsed=parseCSV(text);

    rows=parsed.rows;
    render();

  }catch(e){
    rows=[];
    render();
    $("err").style.display="block";
    $("err").textContent=e.message;
  }
}

async function loadLeagues(){

  const saved=localStorage.getItem(STORAGE_KEY)||DEFAULT_LEAGUE_ID;

  try{
    const res=await fetch(LEAGUES_PATH,{cache:"no-store"});
    const text=await res.text();
    const parsed=parseCSV(text);

    const idIdx=parsed.headers.indexOf("league_id");
    const nameIdx=parsed.headers.indexOf("name");

    const sel=$("leagueSelect");
    sel.innerHTML="";

    parsed.rows.forEach(r=>{
      const opt=document.createElement("option");
      opt.value=r[parsed.headers[idIdx]];
      opt.textContent=
        `${r[parsed.headers[idIdx]]} — ${r[parsed.headers[nameIdx]]}`;
      sel.appendChild(opt);
    });

    sel.value=saved;

  }catch{
    const sel=$("leagueSelect");
    sel.innerHTML=
      `<option value="${DEFAULT_LEAGUE_ID}">
        ${DEFAULT_LEAGUE_ID} — Default League
       </option>`;
  }

  $("leagueSelect").addEventListener("change",()=>{
    localStorage.setItem(STORAGE_KEY,getLeague());
    load();
  });
}

$("search").addEventListener("input",render);
$("reload").addEventListener("click",load);

loadLeagues().then(load);

})();
</script>

</body>
</html>
