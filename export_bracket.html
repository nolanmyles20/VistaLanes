<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bracket Export</title>

  <style>
    /* PAGE = WHITE */
    html, body { height: 100%; }
    body{
      margin:0;
      background:#fff;
      color:#000;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    /* tighter top spacing (shift logos up + remove dead space) */
    .page{
      padding: 10px 12px 12px;
    }

    /* HEADER (compact) */
    .exportHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin: 0 0 8px;  /* small gap to bracket */
    }

    .vistaWrap{
      flex: 1 1 auto;
      display:flex;
      justify-content:center;
      align-items:flex-end;
      min-width: 0;
    }
    .vistaLogo{
      width: min(520px, 72vw);
      height:auto;
      display:block;
    }

    .poweredWrap{
      flex: 0 0 auto;
      display:flex;
      align-items:flex-end;
      gap:10px;
      padding-bottom: 2px;
    }
    .poweredText{
      font-weight:700;
      font-size: 14px;
      color:#000;
      white-space:nowrap;
      margin:0;
      line-height:1;
    }
    .poweredLogo{
      height: 58px;         /* ~1/4-ish visually vs main logo */
      width:auto;
      display:block;
    }

    /* CONTENT HOLDER */
    .exportArea{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    /* this gets scaled by JS to force 1-page fit */
    .scaleWrap{
      transform-origin: top center;
    }

    /* ===========================
       BRACKET THEME (same layout as original dark bracket)
       Keep these styles so exported bracket looks identical
       =========================== */
    :root{
      --border:rgba(255,255,255,.08);
      --text:#d8e1ee;
      --muted:#8ea0b5;
      --accent:#6aa7ff;
      --accent2:#7cf3c3;
      --danger:#ff5a6a;
      --success:#31d07f;
      --warn:#ffc84a;
      --silver:#b8c6d9;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;

      --matchH: 128px;
      --matchGap: 14px;
      --conn: rgba(255,255,255,.12);

      --treePadX: 14px;
      --treeGap: 12px;
    }
    *{box-sizing:border-box}

    /* bracket card */
    .bracket{
      width:min(980px, 100%);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow);
      color: var(--text);
    }

    .bracket .top{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .bracket .top .meta{display:flex;flex-direction:column;gap:4px;}
    .bracket .top .meta .name{font-weight:800;letter-spacing:.3px}
    .bracket .top .meta .small{font-size:12px;color:var(--muted)}
    .bracket .top .tools{display:none !important;} /* ensure export never shows controls */

    .treeHead{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:var(--treeGap);
      padding: 0 var(--treePadX) 10px;
    }
    .treeHead h3{margin:0;font-size:12px;color:var(--muted);letter-spacing:.35px;text-transform:uppercase;}

    .treeScroll{overflow:hidden;}
    .tree{
      position:relative;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:var(--treeGap);
      padding:12px var(--treePadX) 14px;
      overflow:hidden;
      border-radius: 18px;
      width:100%;
    }
    .col{display:flex;flex-direction:column;gap: var(--matchGap);min-width:0;}
    .col.r2{padding-top: calc((var(--matchH) + var(--matchGap)) / 2);}
    .r2Spacer{height: var(--matchH);}
    .col.final{justify-content:center;}

    .match{
      width:100%;
      height: var(--matchH);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      background: rgba(255,255,255,.02);
      padding:8px;
      position:relative;
      overflow:hidden;
      min-width:0;
    }

    .tree::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + (var(--matchH) + var(--matchGap)) + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + 2*(var(--matchH) + var(--matchGap)) + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(33.333% + 2px) calc(12px + 3*(var(--matchH) + var(--matchGap)) + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(66.666% + 2px) calc(12px + (var(--matchH) + var(--matchGap))/2 + var(--matchH) * 0.5) / 18px 1px no-repeat,
        linear-gradient(var(--conn), var(--conn)) calc(66.666% + 2px) calc(12px + (var(--matchH) + var(--matchGap))/2 + var(--matchH) + var(--matchH) + var(--matchGap) + var(--matchH) * 0.5) / 18px 1px no-repeat;
      opacity:.9;
    }

    .slot{
      display:flex;justify-content:space-between;align-items:center;
      padding:7px 10px;border-radius: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:8px;gap:8px;min-width:0;
    }
    .slot:last-child{margin-bottom:0}
    .slot .left{display:flex;flex-direction:column;gap:4px;min-width:0;}
    .slot .nm{
      font-weight:900;line-height:1.05;white-space:normal;overflow:hidden;text-overflow:ellipsis;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-word;
      font-size: 15px;
    }
    .slot .nm .nm1,.slot .nm .nm2{display:block;overflow:hidden;text-overflow:ellipsis;}
    .slot .sc{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.12;}
    .slot .right{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;white-space:nowrap;flex:0 0 auto;}
    .nm.winner{color:var(--success)}
    .nm.loser{color:var(--danger)}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .foot{
      border-top:1px solid rgba(255,255,255,.08);
      padding:12px;
      display:grid;
      gap:10px;
      background: rgba(0,0,0,.10);
    }
    .winnerline{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      padding:10px 12px;border-radius: 16px;
    }
    .winnerline .who{display:flex;gap:10px;align-items:center;min-width:0}
    .winnerline .who .nm{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .winnerline .amt{font-weight:900}
    .badge{
      width:18px;height:18px;border-radius:6px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:900;line-height:1;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
    }
    .badge.gold{background: rgba(255,200,74,.14); border-color: rgba(255,200,74,.45); color: #ffd57a;}
    .badge.silver{background: rgba(184,198,217,.12); border-color: rgba(184,198,217,.42); color: #dbe6f6;}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}
    .muted{color:var(--muted)}

    /* PRINT: one page, no extra margins */
    @page { margin: 10mm; }
    @media print{
      body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .page{ padding: 0; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="exportHeader">
      <div class="vistaWrap">
        <img class="vistaLogo" src="assets/9AB9725D-AD71-4DDC-BE9B-03328F663643.png" alt="Vista Lanes" />
      </div>

      <div class="poweredWrap">
        <p class="poweredText">Powered By</p>
        <img class="poweredLogo" src="assets/68D8CA4C-741E-41E1-ABBC-8B57D7FD0A57.png" alt="Myles Bowling Systems" />
      </div>
    </div>

    <div class="exportArea">
      <div class="scaleWrap" id="scaleWrap">
        <div id="mount" class="hint">Waiting for bracket exportâ€¦</div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const token = qs.get("token");
      const mount = document.getElementById("mount");
      const scaleWrap = document.getElementById("scaleWrap");

      function loadPayload(){
        if(!token) return null;
        try{
          const raw = localStorage.getItem(token);
          if(!raw) return null;
          localStorage.removeItem(token);
          return JSON.parse(raw);
        }catch(e){
          return null;
        }
      }

      function stripExportControls(root){
        // just in case any toolbars slipped in
        root.querySelectorAll("select,input,button,.tools,[data-save-del]").forEach(el => el.remove());
      }

      function scaleToOnePage(){
        // scale to fit current viewport (good enough for iOS print preview)
        const paddingTop = 0;
        const headerH = document.querySelector(".exportHeader")?.getBoundingClientRect().height || 0;
        const availableH = window.innerHeight - headerH - 20 - paddingTop;
        const availableW = window.innerWidth - 24;

        const contentRect = scaleWrap.getBoundingClientRect();
        const w = contentRect.width;
        const h = contentRect.height;

        if(!w || !h) return;

        const s = Math.min(1, availableW / w, availableH / h);
        scaleWrap.style.transform = `scale(${s})`;
      }

      const payload = loadPayload();
      if(!payload || !payload.html){
        // keep the message, but also try to be helpful if token missing
        mount.textContent = "No export payload received. Go back and press Save + Delete again.";
        return;
      }

      document.title = payload.title || "Bracket Export";

      // Render HTML
      mount.outerHTML = payload.html;

      // Clean controls
      stripExportControls(document);

      // Scale after layout
      setTimeout(() => {
        scaleToOnePage();
        setTimeout(() => window.print(), 250);
      }, 50);

      window.addEventListener("resize", () => {
        scaleToOnePage();
      });
    })();
  </script>
</body>
</html>
