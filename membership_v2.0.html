<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vista Lanes • Membership v2.0</title>

<style>
:root{
  --bg:#000;
  --panel: rgba(255,255,255,.04);
  --border: rgba(255,255,255,.10);
  --text:#d8e1ee;
  --muted:#8ea0b5;
  --accent:#6aa7ff;
  --danger:#ff4d4d;
  --success:#28c76f;
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui;background:var(--bg);color:var(--text);}
.wrap{max-width:1200px;margin:0 auto;padding:14px;}
.brandbar{text-align:center;margin-bottom:10px;}
.brandbar img{width:min(340px,86vw);}
.menubar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:14px;}
.menubar a{text-decoration:none;background:#d9d9d9;color:#111;padding:10px 14px;border-radius:999px;font-weight:800;}
.menubar a.active{background:#cfcfcf;}
h1{margin:0 0 10px 0;font-size:22px;font-weight:900;}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:14px;}
.hd{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);}
input,select{background:#111;border:1px solid #333;color:var(--text);padding:8px 10px;border-radius:12px;}
.btn{background:rgba(106,167,255,.18);border:1px solid rgba(255,255,255,.14);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800;}
table{width:100%;border-collapse:collapse;}
thead th{font-size:12px;text-transform:uppercase;color:var(--muted);padding:10px;cursor:pointer;}
tbody td{padding:10px;border-top:1px solid rgba(255,255,255,.05);}
.due-red{color:var(--danger);font-weight:800;}
.credit-green{color:var(--success);font-weight:800;}
</style>
</head>

<body>
<div class="wrap">
<div class="brandbar">
<img src="assets/9AB9725D-AD71-4DDC-BE9B-03328F663643.png">
</div>

<nav class="menubar">
<a href="index.html">Home</a>
<a href="bowlers.html">Bowlers</a>
<a href="leagues.html">Leagues</a>
<a href="teams.html">Teams</a>
<a href="lanes.html">Lanes</a>
<a href="brackets.html">Brackets</a>
<a href="payouts.html">Payouts</a>
<a class="active" href="membership.html">Membership</a>
<a href="tournaments.html">Tournaments</a>
</nav>

<h1>Membership</h1>

<div class="panel">
<div class="hd">
<div class="pill"><b id="count">0</b> members</div>
<select id="leagueSelect"></select>
<input id="search" placeholder="Search bowler...">
<button class="btn" onclick="exportCSV()">Save CSV</button>
</div>

<table>
<thead>
<tr>
<th onclick="sortBy('last_name')">Last Name</th>
<th onclick="sortBy('first_name')">First Name</th>
<th>Dues Owed</th>
<th>Upcoming</th>
<th>Credits</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<script>
let rows=[];
let sortKey="last_name";
let sortAsc=true;
const STORAGE_KEY="vista_selected_league_id";

function parseCSV(text){
  const lines=text.trim().split("\n");
  const headers=lines[0].split(",");
  return lines.slice(1).map(l=>{
    const vals=l.split(",");
    let obj={};
    headers.forEach((h,i)=>obj[h.trim()]=vals[i]);
    return obj;
  });
}

async function loadLeagues(){
  const res=await fetch("data/leagues.csv");
  const txt=await res.text();
  const data=parseCSV(txt);
  const sel=document.getElementById("leagueSelect");
  sel.innerHTML="";
  data.forEach(l=>{
    const opt=document.createElement("option");
    opt.value=l.league_id;
    opt.textContent=l.league_id+" — "+l.name;
    sel.appendChild(opt);
  });
  const saved=localStorage.getItem(STORAGE_KEY)||data[0].league_id;
  sel.value=saved;
  sel.onchange=()=>{
    localStorage.setItem(STORAGE_KEY,sel.value);
    load();
  };
}

async function load(){
  const league=document.getElementById("leagueSelect").value;
  const res=await fetch(`data/membership_${league}.csv`);
  const txt=await res.text();
  rows=parseCSV(txt);
  render();
}

function render(){
  const q=document.getElementById("search").value.toLowerCase();
  let filtered=rows.filter(r=>
    (r.first_name||"").toLowerCase().includes(q) ||
    (r.last_name||"").toLowerCase().includes(q)
  );

  filtered.sort((a,b)=>{
    let v1=(a[sortKey]||"").toLowerCase();
    let v2=(b[sortKey]||"").toLowerCase();
    if(v1<v2) return sortAsc?-1:1;
    if(v1>v2) return sortAsc?1:-1;
    return 0;
  });

  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";
  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.last_name||""}</td>
      <td>${r.first_name||""}</td>
      <td class="${Number(r.dues_owed_to_date)>0?'due-red':''}">$${Number(r.dues_owed_to_date||0).toFixed(2)}</td>
      <td>$${Number(r.upcoming_dues||0).toFixed(2)}</td>
      <td class="${Number(r.credits)>0?'credit-green':''}">$${Number(r.credits||0).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("count").innerText=filtered.length;
}

function sortBy(key){
  if(sortKey===key) sortAsc=!sortAsc;
  else {sortKey=key; sortAsc=true;}
  render();
}

function exportCSV(){
  const headers=Object.keys(rows[0]).join(",");
  const body=rows.map(r=>Object.values(r).join(",")).join("\n");
  const blob=new Blob([headers+"\n"+body],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="membership_export.csv";
  a.click();
}

document.getElementById("search").addEventListener("input",render);

loadLeagues().then(load);
</script>
</body>
</html>
